<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHM: ğŸ“¡ Pub/Subé€šä¿¡å®Œå…¨ã‚¬ã‚¤ãƒ‰ - è¶…é«˜é€Ÿãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SHM
   </div>
   <div id="projectbrief">å…±æœ‰ãƒ¡ãƒ¢ãƒªã‚’ç”¨ã„ãŸé«˜é€Ÿã§æ‰±ã„ã‚„ã™ã„ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãƒãƒãƒ¼ã‚¸ãƒ£</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ğŸ“¡ Pub/Subé€šä¿¡å®Œå…¨ã‚¬ã‚¤ãƒ‰ - è¶…é«˜é€Ÿãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã† </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>[<a href="../md_manual_tutorials_shm_pub_sub_en.html">English</a> | æ—¥æœ¬èª]</p>
<h1><a class="anchor" id="autotoc_md251"></a>
ğŸ¯ ã“ã®ã‚¬ã‚¤ãƒ‰ã§å­¦ã¹ã‚‹ã“ã¨</h1>
<ul>
<li><b>Pub/Subé€šä¿¡ã®æ·±ã„ç†è§£</b>: è¨­è¨ˆæ€æƒ³ã‹ã‚‰å®Ÿè£…è©³ç´°ã¾ã§</li>
<li><b>é«˜é »åº¦é€šä¿¡ã®å®Ÿç¾</b>: 1kHzä»¥ä¸Šã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</li>
<li><b>ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–</b>: å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã®é«˜é€Ÿè»¢é€ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</li>
<li><b>å®Ÿè·µçš„ãªå¿œç”¨ä¾‹</b>: ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡ã€ç”»åƒå‡¦ç†ã€ã‚»ãƒ³ã‚µãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</li>
</ul>
<h1><a class="anchor" id="autotoc_md252"></a>
ğŸ§  Pub/Subé€šä¿¡ã®æ·±ã„ç†è§£</h1>
<h2><a class="anchor" id="autotoc_md253"></a>
ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬</h2>
<div class="fragment"><div class="line"><span class="comment">// å†…éƒ¨æ§‹é€ ã®æ¦‚å¿µå›³</span></div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚                   å…±æœ‰ãƒ¡ãƒ¢ãƒªç©ºé–“                              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</div>
<div class="line">â”‚  â”‚              ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡                          â”‚    â”‚</div>
<div class="line">â”‚  â”‚ [Data 0][Data 1][Data 2]...[Data N-1]              â”‚    â”‚</div>
<div class="line">â”‚  â”‚    â†‘                           â†‘                    â”‚    â”‚</div>
<div class="line">â”‚  â”‚  èª­å–ä½ç½®                    æ›¸è¾¼ä½ç½®                â”‚    â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</div>
<div class="line">â”‚                                                             â”‚</div>
<div class="line">â”‚  ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:                                               â”‚</div>
<div class="line">â”‚  - ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå· (ãƒ‡ãƒ¼ã‚¿ã®é †åºç®¡ç†)                          â”‚</div>
<div class="line">â”‚  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— (ãƒ‡ãƒ¼ã‚¿ã®æ–°é®®åº¦)                           â”‚</div>
<div class="line">â”‚  - ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º (å¯å¤‰é•·ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ)                           â”‚</div>
<div class="line">â”‚  - CRC32ãƒã‚§ãƒƒã‚¯ (ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§)                              â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line"> </div>
<div class="line">Multiple Subscribers â† [shared memory] â† Single Publisher</div>
<div class="line">      â”‚                                        â”‚</div>
<div class="line">   å—ä¿¡ãƒ—ãƒ­ã‚»ã‚¹1                           é€ä¿¡ãƒ—ãƒ­ã‚»ã‚¹</div>
<div class="line">   å—ä¿¡ãƒ—ãƒ­ã‚»ã‚¹2                              â”‚</div>
<div class="line">   å—ä¿¡ãƒ—ãƒ­ã‚»ã‚¹3                        ã‚¼ãƒ­ã‚³ãƒ”ãƒ¼é«˜é€Ÿæ›¸è¾¼</div>
<div class="line">      â”‚</div>
<div class="line">   ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿å‡¦ç†</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md254"></a>
âš¡ ãªãœè¶…é«˜é€Ÿãªã®ã‹ï¼Ÿ</h2>
<p><b>1. ã‚¼ãƒ­ã‚³ãƒ”ãƒ¼è¨­è¨ˆ</b> </p><div class="fragment"><div class="line"><span class="comment">// âŒ å¾“æ¥ã®æ–¹æ³•: ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼ãŒç™ºç”Ÿ</span></div>
<div class="line"><span class="keywordtype">char</span> buffer[1024];</div>
<div class="line">read(socket_fd, buffer, 1024);    <span class="comment">// ã‚«ãƒ¼ãƒãƒ«â†’ãƒ¦ãƒ¼ã‚¶ãƒ¼ç©ºé–“ã‚³ãƒ”ãƒ¼</span></div>
<div class="line">memcpy(data_ptr, buffer, 1024);   <span class="comment">// ãƒãƒƒãƒ•ã‚¡â†’ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚³ãƒ”ãƒ¼</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// âœ… å…±æœ‰ãƒ¡ãƒ¢ãƒª: ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹</span></div>
<div class="line">Publisher&lt;SensorData&gt; pub(<span class="stringliteral">&quot;sensors&quot;</span>);</div>
<div class="line">pub.publish(sensor_data);  <span class="comment">// ãƒ¡ãƒ¢ãƒªã«ç›´æ¥æ›¸è¾¼ã€ã‚³ãƒ”ãƒ¼ãªã—</span></div>
</div><!-- fragment --><p><b>2. åŠ¹ç‡çš„ãªãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡</b> </p><div class="fragment"><div class="line"><span class="comment">// ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ã®åˆ©ç‚¹</span></div>
<div class="line"><span class="keyword">class </span>RingBuffer {</div>
<div class="line">    atomic&lt;size_t&gt; write_index;  <span class="comment">// åŸå­æ“ä½œã§é«˜é€Ÿ</span></div>
<div class="line">    atomic&lt;size_t&gt; read_index;   <span class="comment">// ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼è¨­è¨ˆ</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// æ›¸è¾¼ã¿: O(1)ã®ä¸€å®šæ™‚é–“</span></div>
<div class="line">    <span class="keywordtype">bool</span> write(<span class="keyword">const</span> T&amp; data) {</div>
<div class="line">        <span class="keywordtype">size_t</span> next = (write_index + 1) % buffer_size;</div>
<div class="line">        <span class="keywordflow">if</span> (next != read_index) {  <span class="comment">// ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼æ¤œå‡º</span></div>
<div class="line">            buffer[write_index] = data;</div>
<div class="line">            write_index = next;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// ãƒãƒƒãƒ•ã‚¡ãƒ•ãƒ«</span></div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p><b>3. CPUã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–</b> </p><div class="fragment"><div class="line"><span class="comment">// ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ€é©åŒ–</span></div>
<div class="line"><span class="keyword">struct </span><span class="keyword">alignas</span>(64) CacheOptimizedData {  <span class="comment">// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³å¢ƒç•Œ</span></div>
<div class="line">    atomic&lt;uint64_t&gt; sequence;</div>
<div class="line">    uint64_t timestamp;</div>
<div class="line">    uint32_t data_size;</div>
<div class="line">    uint32_t checksum;</div>
<div class="line">    <span class="keywordtype">char</span> data[MAX_DATA_SIZE];</div>
<div class="line">} __attribute__((packed));</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md255"></a>
ğŸš€ åŸºæœ¬çš„ãªä½¿ã„æ–¹</h1>
<h2><a class="anchor" id="autotoc_md256"></a>
1. ç°¡å˜ãªæ•´æ•°ãƒ‡ãƒ¼ã‚¿é€šä¿¡</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__pub__sub_8hpp.html">shm_pub_sub.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// é€ä¿¡ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="comment">// &quot;test_topic&quot;ã¨ã„ã†åå‰ã§intå‹ã®Publisherã‚’ä½œæˆ</span></div>
<div class="line">    Publisher&lt;int&gt; pub(<span class="stringliteral">&quot;test_topic&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; ++i) {</div>
<div class="line">        pub.publish(i);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;é€ä¿¡: &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(1));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="ashm__pub__sub_8hpp_html"><div class="ttname"><a href="shm__pub__sub_8hpp.html">shm_pub_sub.hpp</a></div><div class="ttdoc">å‡ºç‰ˆ/è³¼èª­ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ãƒˆãƒ”ãƒƒã‚¯é€šä¿¡ã‚’è¦å®šã™ã‚‹ã‚¯ãƒ©ã‚¹ã®å®šç¾©</div></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// å—ä¿¡ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="comment">// &quot;test_topic&quot;ã¨ã„ã†åå‰ã§intå‹ã®Subscriberã‚’ä½œæˆ</span></div>
<div class="line">    Subscriber&lt;int&gt; sub(<span class="stringliteral">&quot;test_topic&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ã‚’å¾…æ©Ÿä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="keywordtype">bool</span> state;</div>
<div class="line">        <span class="keywordtype">int</span> data = sub.subscribe(&amp;state);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (state) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;å—ä¿¡: &quot;</span> &lt;&lt; data &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md257"></a>
2. ã‚«ã‚¹ã‚¿ãƒ æ§‹é€ ä½“ã®é€šä¿¡</h2>
<div class="fragment"><div class="line"><span class="comment">// ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©</span></div>
<div class="line"><span class="keyword">struct </span>SensorData {</div>
<div class="line">    <span class="keywordtype">float</span> temperature;    <span class="comment">// æ¸©åº¦</span></div>
<div class="line">    <span class="keywordtype">float</span> humidity;       <span class="comment">// æ¹¿åº¦</span></div>
<div class="line">    <span class="keywordtype">float</span> pressure;       <span class="comment">// æ°—åœ§</span></div>
<div class="line">    uint64_t timestamp;   <span class="comment">// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span></div>
<div class="line">    <span class="keywordtype">int</span> sensor_id;        <span class="comment">// ã‚»ãƒ³ã‚µãƒ¼ID</span></div>
<div class="line">    <span class="keywordtype">bool</span> is_valid;        <span class="comment">// ãƒ‡ãƒ¼ã‚¿æœ‰åŠ¹æ€§</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// é€ä¿¡å´</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    Publisher&lt;SensorData&gt; sensor_pub(<span class="stringliteral">&quot;weather_data&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        SensorData data;</div>
<div class="line">        data.temperature = 25.5f;</div>
<div class="line">        data.humidity = 60.0f;</div>
<div class="line">        data.pressure = 1013.25f;</div>
<div class="line">        data.timestamp = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</div>
<div class="line">            std::chrono::steady_clock::now().time_since_epoch()).count();</div>
<div class="line">        data.sensor_id = 1;</div>
<div class="line">        data.is_valid = <span class="keyword">true</span>;</div>
<div class="line">        </div>
<div class="line">        sensor_pub.publish(data);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡: æ¸©åº¦=&quot;</span> &lt;&lt; data.temperature &lt;&lt; <span class="stringliteral">&quot;â„ƒ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(2));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// å—ä¿¡å´</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    Subscriber&lt;SensorData&gt; sensor_sub(<span class="stringliteral">&quot;weather_data&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="keywordtype">bool</span> state;</div>
<div class="line">        SensorData data = sensor_sub.subscribe(&amp;state);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (state &amp;&amp; data.is_valid) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;å—ä¿¡ãƒ‡ãƒ¼ã‚¿:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  æ¸©åº¦: &quot;</span> &lt;&lt; data.temperature &lt;&lt; <span class="stringliteral">&quot;â„ƒ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  æ¹¿åº¦: &quot;</span> &lt;&lt; data.humidity &lt;&lt; <span class="stringliteral">&quot;%&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  æ°—åœ§: &quot;</span> &lt;&lt; data.pressure &lt;&lt; <span class="stringliteral">&quot;hPa&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  ã‚»ãƒ³ã‚µãƒ¼ID: &quot;</span> &lt;&lt; data.sensor_id &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(500));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md258"></a>
ğŸš€ å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹</h1>
<h2><a class="anchor" id="autotoc_md259"></a>
1. é«˜é »åº¦ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿é…ä¿¡ (1kHz)</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__pub__sub_8hpp.html">shm_pub_sub.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// é«˜è§£åƒåº¦ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿æ§‹é€ </span></div>
<div class="line"><span class="keyword">struct </span>HighFreqSensorData {</div>
<div class="line">    uint64_t timestamp_us;      <span class="comment">// ãƒã‚¤ã‚¯ãƒ­ç§’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span></div>
<div class="line">    <span class="keywordtype">float</span> position[3];          <span class="comment">// X, Y, Zä½ç½®</span></div>
<div class="line">    <span class="keywordtype">float</span> velocity[3];          <span class="comment">// X, Y, Zé€Ÿåº¦</span></div>
<div class="line">    <span class="keywordtype">float</span> acceleration[3];      <span class="comment">// X, Y, ZåŠ é€Ÿåº¦</span></div>
<div class="line">    <span class="keywordtype">float</span> quaternion[4];        <span class="comment">// å§¿å‹¢ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³ï¼‰</span></div>
<div class="line">    uint32_t sequence_number;   <span class="comment">// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span></div>
<div class="line">    uint8_t sensor_status;      <span class="comment">// ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>HighFrequencyPublisher {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code" href="classirlab_1_1shm_1_1_publisher.html">irlab::shm::Publisher&lt;HighFreqSensorData&gt;</a> publisher_;</div>
<div class="line">    std::thread publishing_thread_;</div>
<div class="line">    std::atomic&lt;bool&gt; running_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    HighFrequencyPublisher(<span class="keyword">const</span> std::string&amp; topic) </div>
<div class="line">        : publisher_(topic), running_(false) {}</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> startPublishing() {</div>
<div class="line">        running_ = <span class="keyword">true</span>;</div>
<div class="line">        publishing_thread_ = std::thread(&amp;HighFrequencyPublisher::publishLoop, <span class="keyword">this</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> stopPublishing() {</div>
<div class="line">        running_ = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (publishing_thread_.joinable()) {</div>
<div class="line">            publishing_thread_.join();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> publishLoop() {</div>
<div class="line">        uint32_t sequence = 0;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 1kHz = 1000å›/ç§’ = 1msé–“éš”</span></div>
<div class="line">        <span class="keyword">auto</span> next_time = std::chrono::high_resolution_clock::now();</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> interval = std::chrono::microseconds(1000);  <span class="comment">// 1ms</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            HighFreqSensorData data;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// é«˜ç²¾åº¦ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span></div>
<div class="line">            <span class="keyword">auto</span> now = std::chrono::high_resolution_clock::now();</div>
<div class="line">            data.timestamp_us = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</div>
<div class="line">                now.time_since_epoch()).count();</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿èª­å–ï¼ˆå®Ÿéš›ã®ã‚»ãƒ³ã‚µãƒ¼APIã«ç½®ãæ›ãˆï¼‰</span></div>
<div class="line">            readSensorData(data);</div>
<div class="line">            data.sequence_number = sequence++;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// è¶…é«˜é€Ÿé€ä¿¡ï¼ˆé€šå¸¸1-2ãƒã‚¤ã‚¯ãƒ­ç§’ï¼‰</span></div>
<div class="line">            publisher_.<a class="code" href="classirlab_1_1shm_1_1_publisher.html#abaac5554b1e838c1069858ca3ca0fde0">publish</a>(data);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ç²¾å¯†ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡</span></div>
<div class="line">            next_time += interval;</div>
<div class="line">            std::this_thread::sleep_until(next_time);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> readSensorData(HighFreqSensorData&amp; data) {</div>
<div class="line">        <span class="comment">// å®Ÿéš›ã®ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­å–</span></div>
<div class="line">        <span class="comment">// ã“ã®éƒ¨åˆ†ã¯ä½¿ç”¨ã™ã‚‹ã‚»ãƒ³ã‚µãƒ¼APIã«ä¾å­˜</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä¾‹</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">float</span> t = 0.0f;</div>
<div class="line">        t += 0.001f;  <span class="comment">// 1msåˆ»ã¿</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µã‚¤ãƒ³æ³¢ã®ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span></div>
<div class="line">        data.position[0] = std::sin(t);</div>
<div class="line">        data.position[1] = std::cos(t);</div>
<div class="line">        data.position[2] = std::sin(t * 2.0f) * 0.5f;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// é€Ÿåº¦ï¼ˆä½ç½®ã®å¾®åˆ†ï¼‰</span></div>
<div class="line">        data.velocity[0] = std::cos(t);</div>
<div class="line">        data.velocity[1] = -std::sin(t);</div>
<div class="line">        data.velocity[2] = std::cos(t * 2.0f);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// åŠ é€Ÿåº¦ï¼ˆé€Ÿåº¦ã®å¾®åˆ†ï¼‰</span></div>
<div class="line">        data.acceleration[0] = -std::sin(t);</div>
<div class="line">        data.acceleration[1] = -std::cos(t);</div>
<div class="line">        data.acceleration[2] = -2.0f * std::sin(t * 2.0f);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³ï¼ˆå˜ä½ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³ï¼‰</span></div>
<div class="line">        data.quaternion[0] = std::cos(t * 0.5f);  <span class="comment">// w</span></div>
<div class="line">        data.quaternion[1] = std::sin(t * 0.5f);  <span class="comment">// x</span></div>
<div class="line">        data.quaternion[2] = 0.0f;                <span class="comment">// y</span></div>
<div class="line">        data.quaternion[3] = 0.0f;                <span class="comment">// z</span></div>
<div class="line">        </div>
<div class="line">        data.sensor_status = 0x01;  <span class="comment">// æ­£å¸¸çŠ¶æ…‹</span></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// é«˜é »åº¦å—ä¿¡ã¨å‡¦ç†</span></div>
<div class="line"><span class="keyword">class </span>HighFrequencySubscriber {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code" href="classirlab_1_1shm_1_1_subscriber.html">irlab::shm::Subscriber&lt;HighFreqSensorData&gt;</a> subscriber_;</div>
<div class="line">    std::thread processing_thread_;</div>
<div class="line">    std::atomic&lt;bool&gt; running_;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ</span></div>
<div class="line">    std::atomic&lt;uint64_t&gt; total_received_;</div>
<div class="line">    std::atomic&lt;uint64_t&gt; missed_packets_;</div>
<div class="line">    uint32_t last_sequence_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    HighFrequencySubscriber(<span class="keyword">const</span> std::string&amp; topic)</div>
<div class="line">        : subscriber_(topic), running_(false), </div>
<div class="line">          total_received_(0), missed_packets_(0), last_sequence_(0) {}</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> startProcessing() {</div>
<div class="line">        running_ = <span class="keyword">true</span>;</div>
<div class="line">        processing_thread_ = std::thread(&amp;HighFrequencySubscriber::processLoop, <span class="keyword">this</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> stopProcessing() {</div>
<div class="line">        running_ = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (processing_thread_.joinable()) {</div>
<div class="line">            processing_thread_.join();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> printStatistics() {</div>
<div class="line">        uint64_t received = total_received_.load();</div>
<div class="line">        uint64_t missed = missed_packets_.load();</div>
<div class="line">        <span class="keywordtype">double</span> packet_loss = received &gt; 0 ? (double)missed / received * 100.0 : 0.0;</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== å—ä¿¡çµ±è¨ˆ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ç·å—ä¿¡æ•°: &quot;</span> &lt;&lt; received &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æ¬ ææ•°: &quot;</span> &lt;&lt; missed &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‘ã‚±ãƒƒãƒˆæ¬ æç‡: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::setprecision(2) </div>
<div class="line">                  &lt;&lt; packet_loss &lt;&lt; <span class="stringliteral">&quot;%&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> processLoop() {</div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            <span class="keywordtype">bool</span> state;</div>
<div class="line">            HighFreqSensorData data = subscriber_.<a class="code" href="classirlab_1_1shm_1_1_subscriber.html#a30f69a6ad1aeb201e9035727bc5920cf">subscribe</a>(&amp;state);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (state) {</div>
<div class="line">                total_received_++;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã§ãƒ‘ã‚±ãƒƒãƒˆæ¬ ææ¤œå‡º</span></div>
<div class="line">                <span class="keywordflow">if</span> (total_received_ &gt; 1) {</div>
<div class="line">                    uint32_t expected = last_sequence_ + 1;</div>
<div class="line">                    <span class="keywordflow">if</span> (data.sequence_number != expected) {</div>
<div class="line">                        missed_packets_ += (data.sequence_number - expected);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                last_sequence_ = data.sequence_number;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// é…å»¶æ¸¬å®š</span></div>
<div class="line">                <span class="keyword">auto</span> now = std::chrono::high_resolution_clock::now();</div>
<div class="line">                <span class="keyword">auto</span> now_us = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</div>
<div class="line">                    now.time_since_epoch()).count();</div>
<div class="line">                int64_t latency = now_us - data.timestamp_us;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ï¼ˆä¾‹ï¼šåˆ¶å¾¡è¨ˆç®—ï¼‰</span></div>
<div class="line">                processRealtimeControl(data, latency);</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// çµ±è¨ˆæƒ…å ±è¡¨ç¤ºï¼ˆä½é »åº¦ï¼‰</span></div>
<div class="line">                <span class="keywordflow">if</span> (total_received_ % 1000 == 0) {  <span class="comment">// 1ç§’æ¯</span></div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: &quot;</span> &lt;&lt; latency &lt;&lt; <span class="stringliteral">&quot;Î¼s, &quot;</span></div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;ã‚·ãƒ¼ã‚±ãƒ³ã‚¹: &quot;</span> &lt;&lt; data.sequence_number &lt;&lt; std::endl;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// é«˜é »åº¦å‡¦ç†ã®ãŸã‚æœ€å°é™ã®å¾…æ©Ÿ</span></div>
<div class="line">            std::this_thread::sleep_for(std::chrono::microseconds(100));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> processRealtimeControl(<span class="keyword">const</span> HighFreqSensorData&amp; data, int64_t latency) {</div>
<div class="line">        <span class="comment">// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¶å¾¡å‡¦ç†ã®ä¾‹</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ä½é…å»¶è¦æ±‚ï¼š10msä»¥ä¸‹</span></div>
<div class="line">        <span class="keywordflow">if</span> (latency &gt; 10000) {  <span class="comment">// 10ms = 10,000Î¼s</span></div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;âš ï¸ é«˜é…å»¶æ¤œå‡º: &quot;</span> &lt;&lt; latency &lt;&lt; <span class="stringliteral">&quot;Î¼s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// å®Ÿéš›ã®åˆ¶å¾¡è¨ˆç®—ï¼ˆä¾‹ï¼šPIDåˆ¶å¾¡ï¼‰</span></div>
<div class="line">        <span class="comment">// ã“ã®éƒ¨åˆ†ã§åˆ¶å¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè£…</span></div>
<div class="line">        calculatePIDControl(data.position, data.velocity);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> calculatePIDControl(<span class="keyword">const</span> <span class="keywordtype">float</span> position[3], <span class="keyword">const</span> <span class="keywordtype">float</span> velocity[3]) {</div>
<div class="line">        <span class="comment">// PIDåˆ¶å¾¡è¨ˆç®—ã®ä¾‹ï¼ˆç°¡ç•¥åŒ–ï¼‰</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">float</span> integral[3] = {0, 0, 0};</div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">float</span> last_error[3] = {0, 0, 0};</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> target[3] = {1.0f, 0.0f, 0.5f};  <span class="comment">// ç›®æ¨™ä½ç½®</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> kp = 2.0f, ki = 0.1f, kd = 0.05f;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; i++) {</div>
<div class="line">            <span class="keywordtype">float</span> error = target[i] - position[i];</div>
<div class="line">            integral[i] += error * 0.001f;  <span class="comment">// 1msé–“éš”</span></div>
<div class="line">            <span class="keywordtype">float</span> derivative = (error - last_error[i]) / 0.001f;</div>
<div class="line">            </div>
<div class="line">            <span class="keywordtype">float</span> control_output = kp * error + ki * integral[i] + kd * derivative;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// åˆ¶å¾¡å‡ºåŠ›ã®é©ç”¨ï¼ˆå®Ÿéš›ã®ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã«é€ä¿¡ï¼‰</span></div>
<div class="line">            <span class="comment">// sendControlCommand(i, control_output);</span></div>
<div class="line">            </div>
<div class="line">            last_error[i] = error;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ä½¿ç”¨ä¾‹</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="comment">// é«˜é »åº¦ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼é–‹å§‹</span></div>
<div class="line">        HighFrequencyPublisher publisher(<span class="stringliteral">&quot;high_freq_sensors&quot;</span>);</div>
<div class="line">        publisher.startPublishing();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// è¤‡æ•°ã®ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰</span></div>
<div class="line">        std::vector&lt;std::unique_ptr&lt;HighFrequencySubscriber&gt;&gt; subscribers;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// åˆ¶å¾¡ç”¨ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼</span></div>
<div class="line">        subscribers.push_back(std::make_unique&lt;HighFrequencySubscriber&gt;(<span class="stringliteral">&quot;high_freq_sensors&quot;</span>));</div>
<div class="line">        subscribers.back()-&gt;startProcessing();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ­ã‚°è¨˜éŒ²ç”¨ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼</span></div>
<div class="line">        subscribers.push_back(std::make_unique&lt;HighFrequencySubscriber&gt;(<span class="stringliteral">&quot;high_freq_sensors&quot;</span>));</div>
<div class="line">        subscribers.back()-&gt;startProcessing();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 10ç§’é–“å®Ÿè¡Œ</span></div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(10));</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// åœæ­¢ã¨çµ±è¨ˆè¡¨ç¤º</span></div>
<div class="line">        publisher.stopPublishing();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; sub : subscribers) {</div>
<div class="line">            sub-&gt;stopProcessing();</div>
<div class="line">            sub-&gt;printStatistics();</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassirlab_1_1shm_1_1_publisher_html"><div class="ttname"><a href="classirlab_1_1shm_1_1_publisher.html">irlab::shm::Publisher</a></div><div class="ttdoc">å…±æœ‰ãƒ¡ãƒ¢ãƒªã«ãƒˆãƒ”ãƒƒã‚¯ã‚’å‡ºåŠ›ã™ã‚‹å‡ºç‰ˆè€…ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹</div><div class="ttdef"><b>Definition:</b> <a href="shm__pub__sub_8hpp_source.html#l00059">shm_pub_sub.hpp:60</a></div></div>
<div class="ttc" id="aclassirlab_1_1shm_1_1_publisher_html_abaac5554b1e838c1069858ca3ca0fde0"><div class="ttname"><a href="classirlab_1_1shm_1_1_publisher.html#abaac5554b1e838c1069858ca3ca0fde0">irlab::shm::Publisher::publish</a></div><div class="ttdeci">void publish(const T &amp;data)</div><div class="ttdoc">ãƒˆãƒ”ãƒƒã‚¯ã®æ›¸ãè¾¼ã¿</div><div class="ttdef"><b>Definition:</b> <a href="shm__pub__sub_8hpp_source.html#l00183">shm_pub_sub.hpp:183</a></div></div>
<div class="ttc" id="aclassirlab_1_1shm_1_1_subscriber_html"><div class="ttname"><a href="classirlab_1_1shm_1_1_subscriber.html">irlab::shm::Subscriber</a></div><div class="ttdoc">å…±æœ‰ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹è³¼èª­è€…ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹</div><div class="ttdef"><b>Definition:</b> <a href="shm__pub__sub_8hpp_source.html#l00094">shm_pub_sub.hpp:95</a></div></div>
<div class="ttc" id="aclassirlab_1_1shm_1_1_subscriber_html_a30f69a6ad1aeb201e9035727bc5920cf"><div class="ttname"><a href="classirlab_1_1shm_1_1_subscriber.html#a30f69a6ad1aeb201e9035727bc5920cf">irlab::shm::Subscriber::subscribe</a></div><div class="ttdeci">const T subscribe(bool *state)</div><div class="ttdoc">ãƒˆãƒ”ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚€</div><div class="ttdef"><b>Definition:</b> <a href="shm__pub__sub_8hpp_source.html#l00251">shm_pub_sub.hpp:251</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md260"></a>
2. ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã®é€šä¿¡</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__pub__sub_8hpp.html">shm_pub_sub.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;shm_pub_sub_vector.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line">    </div>
<div class="line">    Publisher&lt;std::vector&lt;float&gt;&gt; vector_pub(<span class="stringliteral">&quot;vector_data&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="comment">// å‹•çš„ã‚µã‚¤ã‚ºã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿</span></div>
<div class="line">        std::vector&lt;float&gt; sensor_array;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// è¤‡æ•°ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’åé›†</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; ++i) {</div>
<div class="line">            <span class="keywordtype">float</span> value = std::sin(i * 0.1f) * 100.0f;</div>
<div class="line">            sensor_array.push_back(value);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        vector_pub.publish(sensor_array);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿é€ä¿¡: &quot;</span> &lt;&lt; sensor_array.size() &lt;&lt; <span class="stringliteral">&quot;è¦ç´ &quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(500));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line">    </div>
<div class="line">    Subscriber&lt;std::vector&lt;float&gt;&gt; vector_sub(<span class="stringliteral">&quot;vector_data&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="keywordtype">bool</span> state;</div>
<div class="line">        std::vector&lt;float&gt; data = vector_sub.subscribe(&amp;state);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (state) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;å—ä¿¡ãƒ™ã‚¯ãƒˆãƒ« (&quot;</span> &lt;&lt; data.size() &lt;&lt; <span class="stringliteral">&quot;è¦ç´ ): &quot;</span>;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; std::min(data.size(), (<span class="keywordtype">size_t</span>)5); ++i) {</div>
<div class="line">                std::cout &lt;&lt; data[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (data.size() &gt; 5) std::cout &lt;&lt; <span class="stringliteral">&quot;...&quot;</span>;</div>
<div class="line">            std::cout &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md261"></a>
ğŸ› ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</h1>
<h2><a class="anchor" id="autotoc_md262"></a>
1. CPUè¦ªå’Œæ€§è¨­å®š</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>OptimizedPublisher {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setCPUAffinity(<span class="keywordtype">int</span> cpu_core) {</div>
<div class="line">        cpu_set_t cpuset;</div>
<div class="line">        CPU_ZERO(&amp;cpuset);</div>
<div class="line">        CPU_SET(cpu_core, &amp;cpuset);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> result = pthread_setaffinity_np(pthread_self(), <span class="keyword">sizeof</span>(cpu_set_t), &amp;cpuset);</div>
<div class="line">        <span class="keywordflow">if</span> (result != 0) {</div>
<div class="line">            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;CPUè¦ªå’Œæ€§è¨­å®šã«å¤±æ•—&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;CPU&quot;</span> &lt;&lt; cpu_core &lt;&lt; <span class="stringliteral">&quot;ã«å›ºå®šã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> setRealtimePriority() {</div>
<div class="line">        <span class="keyword">struct </span>sched_param param;</div>
<div class="line">        param.sched_priority = 99;  <span class="comment">// æœ€é«˜å„ªå…ˆåº¦</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> result = pthread_setschedparam(pthread_self(), SCHED_FIFO, &amp;param);</div>
<div class="line">        <span class="keywordflow">if</span> (result != 0) {</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å„ªå…ˆåº¦è¨­å®šã«å¤±æ•— (è¦rootæ¨©é™)&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md263"></a>
2. ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«æœ€é©åŒ–</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;memory_resource&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MemoryOptimizedPublisher {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«ã§ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ–</span></div>
<div class="line">    std::array&lt;std::byte, 64 * 1024&gt; buffer_;  <span class="comment">// 64KBå›ºå®šãƒ—ãƒ¼ãƒ«</span></div>
<div class="line">    std::pmr::monotonic_buffer_resource pool_{buffer_.data(), buffer_.size()};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ä½¿ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ</span></div>
<div class="line">    std::pmr::vector&lt;uint8_t&gt; reusable_buffer_{&amp;pool_};</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> optimizedPublish() {</div>
<div class="line">        <span class="comment">// ãƒ¡ãƒ¢ãƒªç¢ºä¿ãŒè¶…é«˜é€Ÿï¼ˆãƒ—ãƒ¼ãƒ«ã‹ã‚‰åˆ‡ã‚Šå‡ºã—ï¼‰</span></div>
<div class="line">        reusable_buffer_.resize(1024);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿æº–å‚™</span></div>
<div class="line">        fillData(reusable_buffer_);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// é€ä¿¡</span></div>
<div class="line">        publisher_.<a class="code" href="classirlab_1_1shm_1_1_publisher.html#abaac5554b1e838c1069858ca3ca0fde0">publish</a>(reusable_buffer_.data(), reusable_buffer_.size());</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ¡ãƒ¢ãƒªå†åˆ©ç”¨ã®ãŸã‚ã‚¯ãƒªã‚¢</span></div>
<div class="line">        reusable_buffer_.clear();</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md264"></a>
ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã¨ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h1>
<h2><a class="anchor" id="autotoc_md265"></a>
è©³ç´°ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PerformanceBenchmark {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::vector&lt;double&gt; latencies_;</div>
<div class="line">    std::vector&lt;double&gt; throughputs_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> runLatencyBenchmark() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯é–‹å§‹ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <a class="code" href="classirlab_1_1shm_1_1_publisher.html">irlab::shm::Publisher&lt;uint64_t&gt;</a> pub(<span class="stringliteral">&quot;latency_test&quot;</span>);</div>
<div class="line">        <a class="code" href="classirlab_1_1shm_1_1_subscriber.html">irlab::shm::Subscriber&lt;uint64_t&gt;</a> sub(<span class="stringliteral">&quot;latency_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> iterations = 10000;</div>
<div class="line">        latencies_.reserve(iterations);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; iterations; ++i) {</div>
<div class="line">            <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::now();</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡</span></div>
<div class="line">            <span class="keyword">auto</span> timestamp = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(</div>
<div class="line">                start.time_since_epoch()).count();</div>
<div class="line">            pub.publish(timestamp);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// å—ä¿¡å¾…ã¡</span></div>
<div class="line">            <span class="keywordtype">bool</span> state;</div>
<div class="line">            uint64_t received_timestamp;</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                received_timestamp = sub.subscribe(&amp;state);</div>
<div class="line">            } <span class="keywordflow">while</span> (!state);</div>
<div class="line">            </div>
<div class="line">            <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::now();</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¨ˆç®—ï¼ˆãƒŠãƒç§’ï¼‰</span></div>
<div class="line">            <span class="keyword">auto</span> latency_ns = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(</div>
<div class="line">                end - start).count();</div>
<div class="line">            latencies_.push_back(latency_ns / 1000.0);  <span class="comment">// ãƒã‚¤ã‚¯ãƒ­ç§’ã«å¤‰æ›</span></div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        analyzeLatency();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> runThroughputBenchmark() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯é–‹å§‹ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// æ§˜ã€…ãªãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã§ãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        std::vector&lt;size_t&gt; data_sizes = {64, 256, 1024, 4096, 16384, 65536};</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> size : data_sizes) {</div>
<div class="line">            measureThroughput(size);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> analyzeLatency() {</div>
<div class="line">        <span class="keywordflow">if</span> (latencies_.empty()) <span class="keywordflow">return</span>;</div>
<div class="line">        </div>
<div class="line">        std::sort(latencies_.begin(), latencies_.end());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">double</span> mean = std::accumulate(latencies_.begin(), latencies_.end(), 0.0) / latencies_.size();</div>
<div class="line">        <span class="keywordtype">double</span> min_val = latencies_.front();</div>
<div class="line">        <span class="keywordtype">double</span> max_val = latencies_.back();</div>
<div class="line">        <span class="keywordtype">double</span> p50 = latencies_[latencies_.size() * 0.5];</div>
<div class="line">        <span class="keywordtype">double</span> p95 = latencies_[latencies_.size() * 0.95];</div>
<div class="line">        <span class="keywordtype">double</span> p99 = latencies_[latencies_.size() * 0.99];</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// åˆ†æ•£è¨ˆç®—</span></div>
<div class="line">        <span class="keywordtype">double</span> variance = 0.0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">double</span> latency : latencies_) {</div>
<div class="line">            variance += (latency - mean) * (latency - mean);</div>
<div class="line">        }</div>
<div class="line">        variance /= latencies_.size();</div>
<div class="line">        <span class="keywordtype">double</span> stddev = std::sqrt(variance);</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆ (Î¼s) ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; std::fixed &lt;&lt; std::setprecision(2);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;å¹³å‡: &quot;</span> &lt;&lt; mean &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€å°: &quot;</span> &lt;&lt; min_val &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€å¤§: &quot;</span> &lt;&lt; max_val &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æ¨™æº–åå·®: &quot;</span> &lt;&lt; stddev &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;50%ile: &quot;</span> &lt;&lt; p50 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;95%ile: &quot;</span> &lt;&lt; p95 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;99%ile: &quot;</span> &lt;&lt; p99 &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¤å®š</span></div>
<div class="line">        <span class="keywordflow">if</span> (p99 &lt; 10.0) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ğŸ† å„ªç§€: 99%ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ10Î¼sä»¥ä¸‹&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p99 &lt; 100.0) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ğŸ‘ è‰¯å¥½: 99%ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ100Î¼sä»¥ä¸‹&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;âš ï¸  è¦æ”¹å–„: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒé«˜ã‚ã§ã™&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> measureThroughput(<span class="keywordtype">size_t</span> data_size) {</div>
<div class="line">        std::vector&lt;uint8_t&gt; test_data(data_size, 0x55);  <span class="comment">// ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³</span></div>
<div class="line">        </div>
<div class="line">        <a class="code" href="classirlab_1_1shm_1_1_publisher.html">irlab::shm::Publisher&lt;std::vector&lt;uint8_t&gt;</a>&gt; pub(<span class="stringliteral">&quot;throughput_test&quot;</span>);</div>
<div class="line">        <a class="code" href="classirlab_1_1shm_1_1_subscriber.html">irlab::shm::Subscriber&lt;std::vector&lt;uint8_t&gt;</a>&gt; sub(<span class="stringliteral">&quot;throughput_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> iterations = 1000;</div>
<div class="line">        <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::now();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// é€ä¿¡å´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread sender([&amp;]() {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; iterations; ++i) {</div>
<div class="line">                pub.publish(test_data);</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// å—ä¿¡å´ã‚«ã‚¦ãƒ³ãƒˆ</span></div>
<div class="line">        <span class="keywordtype">int</span> received_count = 0;</div>
<div class="line">        <span class="keywordflow">while</span> (received_count &lt; iterations) {</div>
<div class="line">            <span class="keywordtype">bool</span> state;</div>
<div class="line">            <span class="keyword">auto</span> data = sub.subscribe(&amp;state);</div>
<div class="line">            <span class="keywordflow">if</span> (state) {</div>
<div class="line">                received_count++;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::now();</div>
<div class="line">        sender.join();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆè¨ˆç®—</span></div>
<div class="line">        <span class="keyword">auto</span> duration_ms = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</div>
<div class="line">            end - start).count();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">double</span> throughput_mbps = (double)(iterations * data_size) / duration_ms / 1024.0;  <span class="comment">// MB/s</span></div>
<div class="line">        <span class="keywordtype">double</span> message_rate = (double)iterations / duration_ms * 1000.0;  <span class="comment">// msg/s</span></div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º &quot;</span> &lt;&lt; data_size &lt;&lt; <span class="stringliteral">&quot; bytes:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::setprecision(1) </div>
<div class="line">                  &lt;&lt; throughput_mbps &lt;&lt; <span class="stringliteral">&quot; MB/s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¬ãƒ¼ãƒˆ: &quot;</span> &lt;&lt; std::setprecision(0) </div>
<div class="line">                  &lt;&lt; message_rate &lt;&lt; <span class="stringliteral">&quot; msg/s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        PerformanceBenchmark benchmark;</div>
<div class="line">        </div>
<div class="line">        benchmark.runLatencyBenchmark();</div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">        benchmark.runThroughputBenchmark();</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md266"></a>
â“ ã‚ˆãã‚ã‚‹è³ªå•</h1>
<h2><a class="anchor" id="autotoc_md267"></a>
Q1. åŒæ™‚ã«æ¥ç¶šã§ãã‚‹Subscriberã®æ•°ã«åˆ¶é™ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>: åŸºæœ¬çš„ã«åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…±æœ‰ãƒ¡ãƒ¢ãƒªã®èª­ã¿å–ã‚Šã¯è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰åŒæ™‚ã«è¡Œãˆã¾ã™ã€‚ãŸã ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ãƒ¢ãƒªé‡ã‚„ãƒ—ãƒ­ã‚»ã‚¹æ•°ã®åˆ¶é™ã«ä¾å­˜ã—ã¾ã™ã€‚</p>
<h2><a class="anchor" id="autotoc_md268"></a>
Q2. ãƒ‡ãƒ¼ã‚¿ã®é †åºã¯ä¿è¨¼ã•ã‚Œã¾ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>: åŒä¸€Publisherå†…ã§ã¯é †åºãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€è¤‡æ•°ã®PublisherãŒã‚ã‚‹å ´åˆã‚„ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ãŒã‚ã‚‹å ´åˆã¯é †åºãŒå‰å¾Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
<h2><a class="anchor" id="autotoc_md269"></a>
Q3. ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>:</p><ul>
<li><b>Publisher</b>: ä»–ã®Subscriberã«å½±éŸ¿ãªã—</li>
<li><b>Subscriber</b>: ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã«å½±éŸ¿ãªã—</li>
<li><b>å…±æœ‰ãƒ¡ãƒ¢ãƒª</b>: ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•ã¾ã§æ®‹å­˜ï¼ˆæ‰‹å‹•å‰Šé™¤å¯èƒ½ï¼‰</li>
</ul>
<h1><a class="anchor" id="autotoc_md270"></a>
ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h1>
<h2><a class="anchor" id="autotoc_md271"></a>
ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•</h2>
<div class="fragment"><div class="line"><span class="comment">// ãƒ‡ãƒãƒƒã‚°ç”¨ã®è¨ºæ–­ã‚³ãƒ¼ãƒ‰</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__pub__sub_8hpp.html">shm_pub_sub.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> diagnose_pub_sub_communication() {</div>
<div class="line">    <span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;=== Pub/Subé€šä¿¡è¨ºæ–­ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="comment">// 1. Publisherä½œæˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        Publisher&lt;int&gt; pub(<span class="stringliteral">&quot;debug_topic&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… Publisherä½œæˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        pub.publish(42);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… ãƒ‡ãƒ¼ã‚¿é€ä¿¡æˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 2. Subscriberä½œæˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        Subscriber&lt;int&gt; sub(<span class="stringliteral">&quot;debug_topic&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… Subscriberä½œæˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">bool</span> state;</div>
<div class="line">        <span class="keywordtype">int</span> data = sub.subscribe(&amp;state);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;å—ä¿¡çµæœ: state=&quot;</span> &lt;&lt; state &lt;&lt; <span class="stringliteral">&quot;, data=&quot;</span> &lt;&lt; data &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (!state) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;âŒ ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ - ä»¥ä¸‹ã‚’ç¢ºèª:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;   - é€ä¿¡ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå‹•ä½œä¸­ã‹ï¼Ÿ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;   - ãƒˆãƒ”ãƒƒã‚¯åãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ï¼Ÿ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âŒ ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md272"></a>
ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h1>
<p>Pub/Subé€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸã‚‰ã€ä»¥ä¸‹ã®é«˜åº¦ãªãƒˆãƒ”ãƒƒã‚¯ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p>
<ol type="1">
<li><b><a class="el" href="md_manual_tutorials_shm_service_jp.html">ğŸ¤ Serviceé€šä¿¡</a></b> - ç¢ºå®Ÿãªè¦æ±‚å¿œç­”é€šä¿¡</li>
<li><b><a class="el" href="md_manual_tutorials_shm_action_jp.html">âš¡ Actioné€šä¿¡</a></b> - é•·æ™‚é–“éåŒæœŸå‡¦ç†</li>
<li><b><a class="el" href="md_manual_tutorials_python_jp.html">ğŸ Pythoné€£æº</a></b> - Pythonã§Pub/Subé€šä¿¡</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md274"></a>
ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±</h1>
<p>æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€shared-memory-based-handy-communication-manager ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦ <b>Apache License 2.0</b> ã®ä¸‹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<ul>
<li>âœ… <b>å•†ç”¨åˆ©ç”¨å¯èƒ½</b>: ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å•†æ¥­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è‡ªç”±ã«ä½¿ç”¨</li>
<li>âœ… <b>æ”¹å¤‰å¯èƒ½</b>: ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ãƒ»æ‹¡å¼µ</li>
<li>âœ… <b>å†é…å¸ƒå¯èƒ½</b>: ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨ç¤ºã‚’ä¿æŒã—ã¦å†é…å¸ƒ</li>
</ul>
<p>è©³ç´°ã¯<a href="../LICENSE">LICENSEãƒ•ã‚¡ã‚¤ãƒ«</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
<hr  />
<p>ã“ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã§ã€Pub/Subé€šä¿¡ã®çœŸã®åŠ›ã‚’å¼•ãå‡ºã—ã€æ¬¡ä¸–ä»£ã®é«˜æ€§èƒ½ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†ï¼ ğŸš€âœ¨ </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jul 6 2025 14:47:59 for SHM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
