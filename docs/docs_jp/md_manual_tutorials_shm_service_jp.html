<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHM: ğŸ¤ Serviceé€šä¿¡å®Œå…¨ã‚¬ã‚¤ãƒ‰ - ç¢ºå®Ÿãªè¦æ±‚å¿œç­”é€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SHM
   </div>
   <div id="projectbrief">å…±æœ‰ãƒ¡ãƒ¢ãƒªã‚’ç”¨ã„ãŸé«˜é€Ÿã§æ‰±ã„ã‚„ã™ã„ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãƒãƒãƒ¼ã‚¸ãƒ£</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ğŸ¤ Serviceé€šä¿¡å®Œå…¨ã‚¬ã‚¤ãƒ‰ - ç¢ºå®Ÿãªè¦æ±‚å¿œç­”é€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã† </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>[<a href="../md_manual_tutorials_shm_service_en.html">English</a> | æ—¥æœ¬èª]</p>
<h1><a class="anchor" id="autotoc_md295"></a>
ğŸ¯ ã“ã®ã‚¬ã‚¤ãƒ‰ã§å­¦ã¹ã‚‹ã“ã¨</h1>
<ul>
<li><b>Serviceé€šä¿¡ã®æ·±ã„ç†è§£</b>: è¦æ±‚å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­è¨ˆæ€æƒ³ã‹ã‚‰å®Ÿè£…è©³ç´°ã¾ã§</li>
<li><b>ä¿¡é ¼æ€§ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿äº¤æ›</b>: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€å†è©¦è¡Œæ©Ÿæ§‹</li>
<li><b>é«˜æ€§èƒ½ã‚µãƒ¼ãƒãƒ¼è¨­è¨ˆ</b>: ä¸¦è¡Œå‡¦ç†ã€è² è·åˆ†æ•£ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–</li>
<li><b>å®Ÿè·µçš„ãªå¿œç”¨ä¾‹</b>: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã€è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã€è¨­å®šç®¡ç†</li>
</ul>
<h1><a class="anchor" id="autotoc_md296"></a>
ğŸ§  Serviceé€šä¿¡ã®æ·±ã„ç†è§£</h1>
<h2><a class="anchor" id="autotoc_md297"></a>
ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬</h2>
<div class="fragment"><div class="line"><span class="comment">// Serviceé€šä¿¡ã®å†…éƒ¨æ§‹é€ </span></div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚                   å…±æœ‰ãƒ¡ãƒ¢ãƒªç©ºé–“                              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</div>
<div class="line">â”‚  â”‚              è¦æ±‚ã‚­ãƒ¥ãƒ¼                             â”‚    â”‚</div>
<div class="line">â”‚  â”‚ [Req 0][Req 1][Req 2]...[Req N-1]                 â”‚    â”‚</div>
<div class="line">â”‚  â”‚    â†‘                           â†‘                    â”‚    â”‚</div>
<div class="line">â”‚  â”‚  å‡¦ç†ä½ç½®                    è¿½åŠ ä½ç½®                â”‚    â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</div>
<div class="line">â”‚                                                             â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</div>
<div class="line">â”‚  â”‚              å¿œç­”ã‚­ãƒ¥ãƒ¼                             â”‚    â”‚</div>
<div class="line">â”‚  â”‚ [Res 0][Res 1][Res 2]...[Res N-1]                 â”‚    â”‚</div>
<div class="line">â”‚  â”‚    â†‘                           â†‘                    â”‚    â”‚</div>
<div class="line">â”‚  â”‚  èª­å–ä½ç½®                    æ›¸è¾¼ä½ç½®                â”‚    â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</div>
<div class="line">â”‚                                                             â”‚</div>
<div class="line">â”‚  è¦æ±‚å¿œç­”ãƒãƒƒãƒ”ãƒ³ã‚°:                                         â”‚</div>
<div class="line">â”‚  - è¦æ±‚ID (ä¸€æ„è­˜åˆ¥å­)                                       â”‚</div>
<div class="line">â”‚  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†)                          â”‚</div>
<div class="line">â”‚  - å‡¦ç†çŠ¶æ…‹ (å¾…æ©Ÿ/å‡¦ç†ä¸­/å®Œäº†)                               â”‚</div>
<div class="line">â”‚  - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ (éšœå®³æ™‚ã®è©³ç´°æƒ…å ±)                           â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line"> </div>
<div class="line">Multiple Clients â† [shared memory] â†’ Single Server</div>
<div class="line">      â”‚                                        â”‚</div>
<div class="line">   è¦æ±‚é€ä¿¡                                å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³</div>
<div class="line">   å¿œç­”å—ä¿¡                                   â”‚</div>
<div class="line">      â”‚                                   ä¸¦åˆ—å‡¦ç†</div>
<div class="line">   ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†                        çµæœç”Ÿæˆ</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md298"></a>
âš¡ ãªãœç¢ºå®Ÿã§é«˜é€Ÿãªã®ã‹ï¼Ÿ</h2>
<p><b>1. åŒæœŸãƒ»éåŒæœŸä¸¡å¯¾å¿œ</b> </p><div class="fragment"><div class="line"><span class="comment">// åŒæœŸé€šä¿¡ï¼ˆç°¡å˜ï¼‰</span></div>
<div class="line">ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;calc_service&quot;</span>);</div>
<div class="line">client.sendRequest(42);</div>
<div class="line"><span class="keywordflow">if</span> (client.waitForResponse(5000000)) {  <span class="comment">// 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">    <span class="keywordtype">int</span> result = client.getResponse();</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;çµæœ: &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// éåŒæœŸé€šä¿¡ï¼ˆé«˜æ€§èƒ½ï¼‰</span></div>
<div class="line">client.sendRequestAsync(42);</div>
<div class="line"><span class="comment">// ä»–ã®å‡¦ç†ã‚’å®Ÿè¡Œ...</span></div>
<div class="line"><span class="keywordflow">if</span> (client.checkResponse()) {</div>
<div class="line">    <span class="keywordtype">int</span> result = client.getResponse();</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;çµæœ: &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>2. ç¢ºå®Ÿãªè¦æ±‚å¿œç­”ãƒãƒƒãƒ”ãƒ³ã‚°</b> </p><div class="fragment"><div class="line"><span class="comment">// å†…éƒ¨çš„ãªè¦æ±‚ç®¡ç†</span></div>
<div class="line"><span class="keyword">struct </span>RequestHeader {</div>
<div class="line">    uint64_t request_id;        <span class="comment">// ä¸€æ„ã®è¦æ±‚ID</span></div>
<div class="line">    uint64_t timestamp_us;      <span class="comment">// é€ä¿¡æ™‚åˆ»</span></div>
<div class="line">    uint32_t timeout_ms;        <span class="comment">// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“</span></div>
<div class="line">    uint32_t retry_count;       <span class="comment">// å†è©¦è¡Œå›æ•°</span></div>
<div class="line">    uint32_t priority;          <span class="comment">// å„ªå…ˆåº¦</span></div>
<div class="line">    RequestStatus status;       <span class="comment">// å‡¦ç†çŠ¶æ…‹</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// è¦æ±‚ã¨å¿œç­”ã®ç¢ºå®Ÿãªå¯¾å¿œä»˜ã‘</span></div>
<div class="line"><span class="keyword">class </span>RequestTracker {</div>
<div class="line">    std::unordered_map&lt;uint64_t, RequestInfo&gt; pending_requests_;</div>
<div class="line">    std::mutex requests_mutex_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    uint64_t addRequest(<span class="keyword">const</span> RequestInfo&amp; info) {</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">        uint64_t <span class="keywordtype">id</span> = generateUniqueId();</div>
<div class="line">        pending_requests_[id] = info;</div>
<div class="line">        <span class="keywordflow">return</span> id;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> checkResponse(uint64_t request_id, ResponseInfo&amp; response) {</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">        <span class="keyword">auto</span> it = pending_requests_.find(request_id);</div>
<div class="line">        <span class="keywordflow">if</span> (it != pending_requests_.end() &amp;&amp; it-&gt;second.status == COMPLETED) {</div>
<div class="line">            response = it-&gt;second.response;</div>
<div class="line">            pending_requests_.erase(it);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p><b>3. é«˜åŠ¹ç‡ãªä¸¦è¡Œå‡¦ç†</b> </p><div class="fragment"><div class="line"><span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ã®ä¸¦è¡Œè¦æ±‚å‡¦ç†</span></div>
<div class="line"><span class="keyword">class </span>ConcurrentServiceServer {</div>
<div class="line">    std::vector&lt;std::thread&gt; worker_threads_;</div>
<div class="line">    std::queue&lt;RequestInfo&gt; request_queue_;</div>
<div class="line">    std::mutex queue_mutex_;</div>
<div class="line">    std::condition_variable queue_cv_;</div>
<div class="line">    std::atomic&lt;bool&gt; running_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> startWorkers(<span class="keywordtype">int</span> num_workers) {</div>
<div class="line">        running_ = <span class="keyword">true</span>;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_workers; ++i) {</div>
<div class="line">            worker_threads_.emplace_back(&amp;ConcurrentServiceServer::workerLoop, <span class="keyword">this</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> workerLoop() {</div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            RequestInfo request;</div>
<div class="line">            {</div>
<div class="line">                std::unique_lock&lt;std::mutex&gt; lock(queue_mutex_);</div>
<div class="line">                queue_cv_.wait(lock, [<span class="keyword">this</span>] { <span class="keywordflow">return</span> !request_queue_.empty() || !running_; });</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">if</span> (!running_) <span class="keywordflow">break</span>;</div>
<div class="line">                </div>
<div class="line">                request = request_queue_.front();</div>
<div class="line">                request_queue_.pop();</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// è¦æ±‚ã‚’ä¸¦åˆ—å‡¦ç†</span></div>
<div class="line">            processRequest(request);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md299"></a>
ğŸš€ åŸºæœ¬çš„ãªä½¿ã„æ–¹</h1>
<h2><a class="anchor" id="autotoc_md300"></a>
1. ç°¡å˜ãªè¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__service_8hpp.html">shm_service.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// è¨ˆç®—è¦æ±‚ãƒ‡ãƒ¼ã‚¿</span></div>
<div class="line"><span class="keyword">struct </span>CalcRequest {</div>
<div class="line">    <span class="keywordtype">int</span> a, b;</div>
<div class="line">    <span class="keywordtype">char</span> operation;  <span class="comment">// &#39;+&#39;, &#39;-&#39;, &#39;*&#39;, &#39;/&#39;</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// è¨ˆç®—çµæœãƒ‡ãƒ¼ã‚¿</span></div>
<div class="line"><span class="keyword">struct </span>CalcResponse {</div>
<div class="line">    <span class="keywordtype">double</span> result;</div>
<div class="line">    <span class="keywordtype">bool</span> success;</div>
<div class="line">    <span class="keywordtype">char</span> error_message[256];</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    ServiceServer&lt;CalcRequest, CalcResponse&gt; server(<span class="stringliteral">&quot;calculator&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;è¨ˆç®—ã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">            CalcRequest request = server.getRequest();</div>
<div class="line">            CalcResponse response;</div>
<div class="line">            </div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;è¦æ±‚å—ä¿¡: &quot;</span> &lt;&lt; request.a &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; request.operation </div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; request.b &lt;&lt; std::endl;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// è¨ˆç®—å‡¦ç†</span></div>
<div class="line">            <span class="keywordflow">switch</span> (request.operation) {</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;+&#39;</span>:</div>
<div class="line">                    response.result = request.a + request.b;</div>
<div class="line">                    response.success = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;-&#39;</span>:</div>
<div class="line">                    response.result = request.a - request.b;</div>
<div class="line">                    response.success = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div>
<div class="line">                    response.result = request.a * request.b;</div>
<div class="line">                    response.success = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;/&#39;</span>:</div>
<div class="line">                    <span class="keywordflow">if</span> (request.b != 0) {</div>
<div class="line">                        response.result = (double)request.a / request.b;</div>
<div class="line">                        response.success = <span class="keyword">true</span>;</div>
<div class="line">                    } <span class="keywordflow">else</span> {</div>
<div class="line">                        response.success = <span class="keyword">false</span>;</div>
<div class="line">                        strncpy(response.error_message, <span class="stringliteral">&quot;Division by zero&quot;</span>, 255);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    response.success = <span class="keyword">false</span>;</div>
<div class="line">                    strncpy(response.error_message, <span class="stringliteral">&quot;Unknown operation&quot;</span>, 255);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            server.sendResponse(response);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (response.success) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;çµæœé€ä¿¡: &quot;</span> &lt;&lt; response.result &lt;&lt; std::endl;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼é€ä¿¡: &quot;</span> &lt;&lt; response.error_message &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(10));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="ashm__service_8hpp_html"><div class="ttname"><a href="shm__service_8hpp.html">shm_service.hpp</a></div><div class="ttdoc">ãƒ¡ãƒ¢ãƒªã®æ ¼ç´æ–¹æ³•ã‚’è¦å®šã™ã‚‹ã‚¯ãƒ©ã‚¹ã®å®šç¾©</div></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    ServiceClient&lt;CalcRequest, CalcResponse&gt; client(<span class="stringliteral">&quot;calculator&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;è¨ˆç®—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        CalcRequest request;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æ•°å€¤1ã‚’å…¥åŠ›: &quot;</span>;</div>
<div class="line">        std::cin &gt;&gt; request.a;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æ¼”ç®—å­ã‚’å…¥åŠ› (+, -, *, /): &quot;</span>;</div>
<div class="line">        std::cin &gt;&gt; request.operation;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æ•°å€¤2ã‚’å…¥åŠ›: &quot;</span>;</div>
<div class="line">        std::cin &gt;&gt; request.b;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// è¦æ±‚é€ä¿¡</span></div>
<div class="line">        client.sendRequest(request);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;è¦æ±‚é€ä¿¡å®Œäº†...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// å¿œç­”å¾…æ©Ÿï¼ˆæœ€å¤§5ç§’ï¼‰</span></div>
<div class="line">        <span class="keywordflow">if</span> (client.waitForResponse(5000000)) {  <span class="comment">// 5ç§’ = 5,000,000ãƒã‚¤ã‚¯ãƒ­ç§’</span></div>
<div class="line">            CalcResponse response = client.getResponse();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (response.success) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;è¨ˆç®—çµæœ: &quot;</span> &lt;&lt; response.result &lt;&lt; std::endl;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; response.error_message &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n): &quot;</span>;</div>
<div class="line">        <span class="keywordtype">char</span> cont;</div>
<div class="line">        std::cin &gt;&gt; cont;</div>
<div class="line">        <span class="keywordflow">if</span> (cont != <span class="charliteral">&#39;y&#39;</span> &amp;&amp; cont != <span class="charliteral">&#39;Y&#39;</span>) <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md301"></a>
2. è¤‡åˆãƒ‡ãƒ¼ã‚¿å‹ã®é€šä¿¡</h2>
<div class="fragment"><div class="line"><span class="comment">// è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¾‹</span></div>
<div class="line"><span class="keyword">struct </span>ImageProcessRequest {</div>
<div class="line">    uint32_t width, height;</div>
<div class="line">    uint8_t format;           <span class="comment">// 0=RGB, 1=RGBA, 2=GRAY</span></div>
<div class="line">    uint32_t data_size;</div>
<div class="line">    <span class="keywordtype">char</span> image_data[1024*1024];  <span class="comment">// æœ€å¤§1MB</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// å‡¦ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</span></div>
<div class="line">    <span class="keywordtype">float</span> brightness;</div>
<div class="line">    <span class="keywordtype">float</span> contrast;</div>
<div class="line">    <span class="keywordtype">float</span> saturation;</div>
<div class="line">    <span class="keywordtype">bool</span> apply_blur;</div>
<div class="line">    <span class="keywordtype">float</span> blur_radius;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>ImageProcessResponse {</div>
<div class="line">    <span class="keywordtype">bool</span> success;</div>
<div class="line">    uint32_t processed_size;</div>
<div class="line">    <span class="keywordtype">char</span> processed_data[1024*1024];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// å‡¦ç†çµæœæƒ…å ±</span></div>
<div class="line">    uint32_t processing_time_ms;</div>
<div class="line">    <span class="keywordtype">char</span> algorithm_used[128];</div>
<div class="line">    <span class="keywordtype">float</span> quality_score;</div>
<div class="line">    <span class="keywordtype">char</span> error_details[512];</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ç”»åƒå‡¦ç†ã‚µãƒ¼ãƒãƒ¼</span></div>
<div class="line"><span class="keyword">class </span>ImageProcessingServer {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    ServiceServer&lt;ImageProcessRequest, ImageProcessResponse&gt; server_;</div>
<div class="line">    std::thread processing_thread_;</div>
<div class="line">    std::atomic&lt;bool&gt; running_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    ImageProcessingServer() : server_(<span class="stringliteral">&quot;image_processor&quot;</span>), running_(false) {}</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> start() {</div>
<div class="line">        running_ = <span class="keyword">true</span>;</div>
<div class="line">        processing_thread_ = std::thread(&amp;ImageProcessingServer::processLoop, <span class="keyword">this</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ç”»åƒå‡¦ç†ã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> stop() {</div>
<div class="line">        running_ = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (processing_thread_.joinable()) {</div>
<div class="line">            processing_thread_.join();</div>
<div class="line">        }</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ç”»åƒå‡¦ç†ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> processLoop() {</div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            <span class="keywordflow">if</span> (server_.hasRequest()) {</div>
<div class="line">                <span class="keyword">auto</span> start_time = std::chrono::high_resolution_clock::now();</div>
<div class="line">                </div>
<div class="line">                ImageProcessRequest request = server_.getRequest();</div>
<div class="line">                ImageProcessResponse response;</div>
<div class="line">                </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ç”»åƒå‡¦ç†è¦æ±‚å—ä¿¡: &quot;</span> &lt;&lt; request.width &lt;&lt; <span class="stringliteral">&quot;x&quot;</span> &lt;&lt; request.height</div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;, ã‚µã‚¤ã‚º: &quot;</span> &lt;&lt; request.data_size &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// ç”»åƒå‡¦ç†å®Ÿè¡Œ</span></div>
<div class="line">                <span class="keywordtype">bool</span> success = processImage(request, response);</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">auto</span> end_time = std::chrono::high_resolution_clock::now();</div>
<div class="line">                <span class="keyword">auto</span> duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</div>
<div class="line">                    end_time - start_time);</div>
<div class="line">                </div>
<div class="line">                response.processing_time_ms = duration.count();</div>
<div class="line">                response.success = success;</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">if</span> (success) {</div>
<div class="line">                    strncpy(response.algorithm_used, <span class="stringliteral">&quot;Advanced Filter v2.1&quot;</span>, 127);</div>
<div class="line">                    response.quality_score = calculateQualityScore(response);</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;å‡¦ç†å®Œäº†: &quot;</span> &lt;&lt; response.processing_time_ms &lt;&lt; <span class="stringliteral">&quot;ms, &quot;</span></div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;å“è³ªã‚¹ã‚³ã‚¢: &quot;</span> &lt;&lt; response.quality_score &lt;&lt; std::endl;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    strncpy(response.error_details, <span class="stringliteral">&quot;ç”»åƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ&quot;</span>, 511);</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;å‡¦ç†å¤±æ•—: &quot;</span> &lt;&lt; response.error_details &lt;&lt; std::endl;</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                server_.sendResponse(response);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            std::this_thread::sleep_for(std::chrono::milliseconds(5));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> processImage(<span class="keyword">const</span> ImageProcessRequest&amp; request, ImageProcessResponse&amp; response) {</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="comment">// å…¥åŠ›æ¤œè¨¼</span></div>
<div class="line">            <span class="keywordflow">if</span> (request.data_size == 0 || request.width == 0 || request.height == 0) {</div>
<div class="line">                strncpy(response.error_details, <span class="stringliteral">&quot;ç„¡åŠ¹ãªç”»åƒãƒ‡ãƒ¼ã‚¿&quot;</span>, 511);</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// å®Ÿéš›ã®ç”»åƒå‡¦ç†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </span></div>
<div class="line">            <span class="comment">// ã“ã®ä¾‹ã§ã¯ç°¡å˜ãªå‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</span></div>
<div class="line">            </div>
<div class="line">            <span class="comment">// æ˜åº¦èª¿æ•´</span></div>
<div class="line">            <span class="keywordtype">float</span> brightness_factor = 1.0f + request.brightness;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆèª¿æ•´</span></div>
<div class="line">            <span class="keywordtype">float</span> contrast_factor = request.contrast;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// è‰²ã®å‡¦ç†ï¼ˆã“ã®ä¾‹ã§ã¯å˜ç´”åŒ–ï¼‰</span></div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; request.data_size; ++i) {</div>
<div class="line">                uint8_t pixel = request.image_data[i];</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// æ˜åº¦èª¿æ•´</span></div>
<div class="line">                <span class="keywordtype">float</span> adjusted = pixel * brightness_factor;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆèª¿æ•´</span></div>
<div class="line">                adjusted = (adjusted - 128.0f) * contrast_factor + 128.0f;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// ç¯„å›²ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°</span></div>
<div class="line">                adjusted = std::max(0.0f, std::min(255.0f, adjusted));</div>
<div class="line">                </div>
<div class="line">                response.processed_data[i] = <span class="keyword">static_cast&lt;</span>uint8_t<span class="keyword">&gt;</span>(adjusted);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            response.processed_size = request.data_size;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// ãƒ–ãƒ©ãƒ¼å‡¦ç†ï¼ˆè¦æ±‚ãŒã‚ã‚Œã°ï¼‰</span></div>
<div class="line">            <span class="keywordflow">if</span> (request.apply_blur) {</div>
<div class="line">                applyBlur(response.processed_data, request.width, request.height, </div>
<div class="line">                         request.blur_radius);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            </div>
<div class="line">        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">            strncpy(response.error_details, e.what(), 511);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> applyBlur(<span class="keywordtype">char</span>* data, uint32_t width, uint32_t height, <span class="keywordtype">float</span> radius) {</div>
<div class="line">        <span class="comment">// ç°¡å˜ãªãƒœãƒƒã‚¯ã‚¹ãƒ–ãƒ©ãƒ¼ã®å®Ÿè£…</span></div>
<div class="line">        <span class="comment">// å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚ˆã‚Šé«˜åº¦ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> blur_size = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(radius);</div>
<div class="line">        <span class="keywordflow">if</span> (blur_size &lt;= 0) <span class="keywordflow">return</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// æ°´å¹³æ–¹å‘ã®ãƒ–ãƒ©ãƒ¼</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t y = 0; y &lt; height; ++y) {</div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t x = blur_size; x &lt; width - blur_size; ++x) {</div>
<div class="line">                <span class="keywordtype">int</span> sum = 0;</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dx = -blur_size; dx &lt;= blur_size; ++dx) {</div>
<div class="line">                    sum += <span class="keyword">static_cast&lt;</span>uint8_t<span class="keyword">&gt;</span>(data[y * width + x + dx]);</div>
<div class="line">                }</div>
<div class="line">                data[y * width + x] = sum / (2 * blur_size + 1);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">float</span> calculateQualityScore(<span class="keyword">const</span> ImageProcessResponse&amp; response) {</div>
<div class="line">        <span class="comment">// å“è³ªã‚¹ã‚³ã‚¢ã®è¨ˆç®—ï¼ˆç°¡ç•¥åŒ–ï¼‰</span></div>
<div class="line">        <span class="keywordtype">float</span> score = 0.8f + (response.processing_time_ms &lt; 100 ? 0.2f : 0.1f);</div>
<div class="line">        <span class="keywordflow">return</span> std::min(1.0f, score);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ä½¿ç”¨ä¾‹</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    ImageProcessingServer server;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        server.start();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼ã‚’10ç§’é–“å®Ÿè¡Œ</span></div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(10));</div>
<div class="line">        </div>
<div class="line">        server.stop();</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md302"></a>
ğŸš€ å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹</h1>
<h2><a class="anchor" id="autotoc_md303"></a>
1. é«˜æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__service_8hpp.html">shm_service.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unordered_map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;shared_mutex&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®å®šç¾©</span></div>
<div class="line"><span class="keyword">enum class</span> DbOperation {</div>
<div class="line">    INSERT,</div>
<div class="line">    SELECT,</div>
<div class="line">    UPDATE,</div>
<div class="line">    DELETE,</div>
<div class="line">    CREATE_TABLE,</div>
<div class="line">    DROP_TABLE</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦æ±‚</span></div>
<div class="line"><span class="keyword">struct </span>DatabaseRequest {</div>
<div class="line">    DbOperation operation;</div>
<div class="line">    <span class="keywordtype">char</span> table_name[64];</div>
<div class="line">    <span class="keywordtype">char</span> key[128];</div>
<div class="line">    <span class="keywordtype">char</span> value[1024];</div>
<div class="line">    <span class="keywordtype">char</span> condition[256];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</span></div>
<div class="line">    uint64_t client_id;</div>
<div class="line">    uint32_t priority;</div>
<div class="line">    <span class="keywordtype">bool</span> require_transaction;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¿œç­”</span></div>
<div class="line"><span class="keyword">struct </span>DatabaseResponse {</div>
<div class="line">    <span class="keywordtype">bool</span> success;</div>
<div class="line">    uint32_t affected_rows;</div>
<div class="line">    <span class="keywordtype">char</span> result_data[2048];</div>
<div class="line">    <span class="keywordtype">char</span> error_message[512];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±</span></div>
<div class="line">    uint64_t execution_time_us;</div>
<div class="line">    uint32_t memory_used;</div>
<div class="line">    uint32_t disk_reads;</div>
<div class="line">    uint32_t disk_writes;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// é«˜æ€§èƒ½ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</span></div>
<div class="line"><span class="keyword">class </span>HighPerformanceDatabase {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</span></div>
<div class="line">    std::unordered_map&lt;std::string, std::unordered_map&lt;std::string, std::string&gt;&gt; tables_;</div>
<div class="line">    std::shared_mutex data_mutex_;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</span></div>
<div class="line">    std::atomic&lt;uint64_t&gt; total_requests_{0};</div>
<div class="line">    std::atomic&lt;uint64_t&gt; total_execution_time_{0};</div>
<div class="line">    std::atomic&lt;uint32_t&gt; active_connections_{0};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†</span></div>
<div class="line">    ServiceServer&lt;DatabaseRequest, DatabaseResponse&gt; server_;</div>
<div class="line">    std::vector&lt;std::thread&gt; worker_threads_;</div>
<div class="line">    std::atomic&lt;bool&gt; running_{<span class="keyword">false</span>};</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    HighPerformanceDatabase() : server_(<span class="stringliteral">&quot;database_service&quot;</span>) {}</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> start(<span class="keywordtype">int</span> num_workers = 4) {</div>
<div class="line">        running_ = <span class="keyword">true</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_workers; ++i) {</div>
<div class="line">            worker_threads_.emplace_back(&amp;HighPerformanceDatabase::workerLoop, <span class="keyword">this</span>, i);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã—ãŸ (&quot;</span> &lt;&lt; num_workers &lt;&lt; <span class="stringliteral">&quot; workers)&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// çµ±è¨ˆæƒ…å ±ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹</span></div>
<div class="line">        worker_threads_.emplace_back(&amp;HighPerformanceDatabase::statisticsLoop, <span class="keyword">this</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> stop() {</div>
<div class="line">        running_ = <span class="keyword">false</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; thread : worker_threads_) {</div>
<div class="line">            <span class="keywordflow">if</span> (thread.joinable()) {</div>
<div class="line">                thread.join();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> workerLoop(<span class="keywordtype">int</span> worker_id) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Worker &quot;</span> &lt;&lt; worker_id &lt;&lt; <span class="stringliteral">&quot; ã‚’é–‹å§‹ã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            <span class="keywordflow">if</span> (server_.hasRequest()) {</div>
<div class="line">                active_connections_++;</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">auto</span> start_time = std::chrono::high_resolution_clock::now();</div>
<div class="line">                </div>
<div class="line">                DatabaseRequest request = server_.getRequest();</div>
<div class="line">                DatabaseResponse response = processRequest(request);</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">auto</span> end_time = std::chrono::high_resolution_clock::now();</div>
<div class="line">                <span class="keyword">auto</span> duration = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</div>
<div class="line">                    end_time - start_time);</div>
<div class="line">                </div>
<div class="line">                response.execution_time_us = duration.count();</div>
<div class="line">                </div>
<div class="line">                server_.sendResponse(response);</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// çµ±è¨ˆæƒ…å ±æ›´æ–°</span></div>
<div class="line">                total_requests_++;</div>
<div class="line">                total_execution_time_ += duration.count();</div>
<div class="line">                active_connections_--;</div>
<div class="line">                </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Worker &quot;</span> &lt;&lt; worker_id &lt;&lt; <span class="stringliteral">&quot; å‡¦ç†å®Œäº†: &quot;</span> </div>
<div class="line">                          &lt;&lt; response.execution_time_us &lt;&lt; <span class="stringliteral">&quot;Î¼s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            std::this_thread::sleep_for(std::chrono::microseconds(100));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse processRequest(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        response.success = <span class="keyword">false</span>;</div>
<div class="line">        response.affected_rows = 0;</div>
<div class="line">        response.memory_used = 0;</div>
<div class="line">        response.disk_reads = 0;</div>
<div class="line">        response.disk_writes = 0;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="keywordflow">switch</span> (request.operation) {</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::CREATE_TABLE:</div>
<div class="line">                    response = createTable(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::INSERT:</div>
<div class="line">                    response = insertData(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::SELECT:</div>
<div class="line">                    response = selectData(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::UPDATE:</div>
<div class="line">                    response = updateData(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::DELETE:</div>
<div class="line">                    response = deleteData(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> DbOperation::DROP_TABLE:</div>
<div class="line">                    response = dropTable(request);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    strncpy(response.error_message, <span class="stringliteral">&quot;æœªçŸ¥ã®æ“ä½œ&quot;</span>, 511);</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">            strncpy(response.error_message, e.what(), 511);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse createTable(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::unique_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (tables_.find(table_name) != tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        tables_[table_name] = std::unordered_map&lt;std::string, std::string&gt;();</div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.affected_rows = 1;</div>
<div class="line">        response.disk_writes = 1;</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ: &quot;</span> &lt;&lt; table_name &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse insertData(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::unique_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        std::string key = request.key;</div>
<div class="line">        std::string value = request.value;</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> table_it = tables_.find(table_name);</div>
<div class="line">        <span class="keywordflow">if</span> (table_it == tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        table_it-&gt;second[key] = value;</div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.affected_rows = 1;</div>
<div class="line">        response.disk_writes = 1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse selectData(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::shared_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        std::string key = request.key;</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> table_it = tables_.find(table_name);</div>
<div class="line">        <span class="keywordflow">if</span> (table_it == tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (key.empty()) {</div>
<div class="line">            <span class="comment">// å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—</span></div>
<div class="line">            std::string result;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; pair : table_it-&gt;second) {</div>
<div class="line">                result += pair.first + <span class="stringliteral">&quot;=&quot;</span> + pair.second + <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            strncpy(response.result_data, result.c_str(), 2047);</div>
<div class="line">            response.affected_rows = table_it-&gt;second.size();</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">// ç‰¹å®šã‚­ãƒ¼ã®å–å¾—</span></div>
<div class="line">            <span class="keyword">auto</span> data_it = table_it-&gt;second.find(key);</div>
<div class="line">            <span class="keywordflow">if</span> (data_it != table_it-&gt;second.end()) {</div>
<div class="line">                strncpy(response.result_data, data_it-&gt;second.c_str(), 2047);</div>
<div class="line">                response.affected_rows = 1;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                strncpy(response.error_message, <span class="stringliteral">&quot;ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">                <span class="keywordflow">return</span> response;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.disk_reads = 1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse updateData(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::unique_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        std::string key = request.key;</div>
<div class="line">        std::string value = request.value;</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> table_it = tables_.find(table_name);</div>
<div class="line">        <span class="keywordflow">if</span> (table_it == tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> data_it = table_it-&gt;second.find(key);</div>
<div class="line">        <span class="keywordflow">if</span> (data_it == table_it-&gt;second.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        data_it-&gt;second = value;</div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.affected_rows = 1;</div>
<div class="line">        response.disk_writes = 1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse deleteData(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::unique_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        std::string key = request.key;</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> table_it = tables_.find(table_name);</div>
<div class="line">        <span class="keywordflow">if</span> (table_it == tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> data_it = table_it-&gt;second.find(key);</div>
<div class="line">        <span class="keywordflow">if</span> (data_it == table_it-&gt;second.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        table_it-&gt;second.erase(data_it);</div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.affected_rows = 1;</div>
<div class="line">        response.disk_writes = 1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    DatabaseResponse dropTable(<span class="keyword">const</span> DatabaseRequest&amp; request) {</div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        </div>
<div class="line">        std::unique_lock&lt;std::shared_mutex&gt; lock(data_mutex_);</div>
<div class="line">        </div>
<div class="line">        std::string table_name = request.table_name;</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> table_it = tables_.find(table_name);</div>
<div class="line">        <span class="keywordflow">if</span> (table_it == tables_.end()) {</div>
<div class="line">            strncpy(response.error_message, <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“&quot;</span>, 511);</div>
<div class="line">            <span class="keywordflow">return</span> response;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        tables_.erase(table_it);</div>
<div class="line">        response.success = <span class="keyword">true</span>;</div>
<div class="line">        response.affected_rows = 1;</div>
<div class="line">        response.disk_writes = 1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> response;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> statisticsLoop() {</div>
<div class="line">        <span class="keywordflow">while</span> (running_) {</div>
<div class="line">            std::this_thread::sleep_for(std::chrono::seconds(5));</div>
<div class="line">            </div>
<div class="line">            uint64_t total_reqs = total_requests_.load();</div>
<div class="line">            uint64_t total_time = total_execution_time_.load();</div>
<div class="line">            uint32_t active_conns = active_connections_.load();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (total_reqs &gt; 0) {</div>
<div class="line">                <span class="keywordtype">double</span> avg_time = (double)total_time / total_reqs;</div>
<div class="line">                <span class="keywordtype">double</span> reqs_per_sec = total_reqs / 5.0;  <span class="comment">// 5ç§’é–“éš”</span></div>
<div class="line">                </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ç·è¦æ±‚æ•°: &quot;</span> &lt;&lt; total_reqs &lt;&lt; std::endl;</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;å¹³å‡å‡¦ç†æ™‚é–“: &quot;</span> &lt;&lt; avg_time &lt;&lt; <span class="stringliteral">&quot;Î¼s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;è¦æ±‚/ç§’: &quot;</span> &lt;&lt; reqs_per_sec &lt;&lt; std::endl;</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶š: &quot;</span> &lt;&lt; active_conns &lt;&lt; std::endl;</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«æ•°: &quot;</span> &lt;&lt; tables_.size() &lt;&lt; std::endl;</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ</span></div>
<div class="line">                total_requests_ = 0;</div>
<div class="line">                total_execution_time_ = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</span></div>
<div class="line"><span class="keyword">class </span>DatabaseClient {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    ServiceClient&lt;DatabaseRequest, DatabaseResponse&gt; client_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    DatabaseClient() : client_(<span class="stringliteral">&quot;database_service&quot;</span>) {}</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> createTable(<span class="keyword">const</span> std::string&amp; table_name) {</div>
<div class="line">        DatabaseRequest request;</div>
<div class="line">        request.operation = DbOperation::CREATE_TABLE;</div>
<div class="line">        strncpy(request.table_name, table_name.c_str(), 63);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> executeRequest(request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> insert(<span class="keyword">const</span> std::string&amp; table, <span class="keyword">const</span> std::string&amp; key, <span class="keyword">const</span> std::string&amp; value) {</div>
<div class="line">        DatabaseRequest request;</div>
<div class="line">        request.operation = DbOperation::INSERT;</div>
<div class="line">        strncpy(request.table_name, table.c_str(), 63);</div>
<div class="line">        strncpy(request.key, key.c_str(), 127);</div>
<div class="line">        strncpy(request.value, value.c_str(), 1023);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> executeRequest(request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    std::string select(<span class="keyword">const</span> std::string&amp; table, <span class="keyword">const</span> std::string&amp; key = <span class="stringliteral">&quot;&quot;</span>) {</div>
<div class="line">        DatabaseRequest request;</div>
<div class="line">        request.operation = DbOperation::SELECT;</div>
<div class="line">        strncpy(request.table_name, table.c_str(), 63);</div>
<div class="line">        strncpy(request.key, key.c_str(), 127);</div>
<div class="line">        </div>
<div class="line">        DatabaseResponse response;</div>
<div class="line">        <span class="keywordflow">if</span> (executeRequest(request, &amp;response)) {</div>
<div class="line">            <span class="keywordflow">return</span> std::string(response.result_data);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> update(<span class="keyword">const</span> std::string&amp; table, <span class="keyword">const</span> std::string&amp; key, <span class="keyword">const</span> std::string&amp; value) {</div>
<div class="line">        DatabaseRequest request;</div>
<div class="line">        request.operation = DbOperation::UPDATE;</div>
<div class="line">        strncpy(request.table_name, table.c_str(), 63);</div>
<div class="line">        strncpy(request.key, key.c_str(), 127);</div>
<div class="line">        strncpy(request.value, value.c_str(), 1023);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> executeRequest(request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> deleteRecord(<span class="keyword">const</span> std::string&amp; table, <span class="keyword">const</span> std::string&amp; key) {</div>
<div class="line">        DatabaseRequest request;</div>
<div class="line">        request.operation = DbOperation::DELETE;</div>
<div class="line">        strncpy(request.table_name, table.c_str(), 63);</div>
<div class="line">        strncpy(request.key, key.c_str(), 127);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> executeRequest(request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">bool</span> executeRequest(<span class="keyword">const</span> DatabaseRequest&amp; request, DatabaseResponse* response = <span class="keyword">nullptr</span>) {</div>
<div class="line">        client_.sendRequest(request);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (client_.waitForResponse(10000000)) {  <span class="comment">// 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">            DatabaseResponse resp = client_.getResponse();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (response) {</div>
<div class="line">                *response = resp;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (!resp.success) {</div>
<div class="line">                std::cerr &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; resp.error_message &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">return</span> resp.success;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ä½¿ç”¨ä¾‹</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹</span></div>
<div class="line">        HighPerformanceDatabase db;</div>
<div class="line">        db.start(4);  <span class="comment">// 4ãƒ¯ãƒ¼ã‚«ãƒ¼</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        DatabaseClient client;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ</span></div>
<div class="line">        <span class="keywordflow">if</span> (client.createTable(<span class="stringliteral">&quot;users&quot;</span>)) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥</span></div>
<div class="line">        client.insert(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user1&quot;</span>, <span class="stringliteral">&quot;Alice&quot;</span>);</div>
<div class="line">        client.insert(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user2&quot;</span>, <span class="stringliteral">&quot;Bob&quot;</span>);</div>
<div class="line">        client.insert(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user3&quot;</span>, <span class="stringliteral">&quot;Charlie&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿å–å¾—</span></div>
<div class="line">        std::string result = client.select(<span class="stringliteral">&quot;users&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼:\n&quot;</span> &lt;&lt; result &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ç‰¹å®šãƒ‡ãƒ¼ã‚¿å–å¾—</span></div>
<div class="line">        std::string alice = client.select(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user1&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;user1: &quot;</span> &lt;&lt; alice &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿æ›´æ–°</span></div>
<div class="line">        client.update(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user1&quot;</span>, <span class="stringliteral">&quot;Alice Smith&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</span></div>
<div class="line">        client.deleteRecord(<span class="stringliteral">&quot;users&quot;</span>, <span class="stringliteral">&quot;user3&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// æœ€çµ‚çµæœç¢ºèª</span></div>
<div class="line">        result = client.select(<span class="stringliteral">&quot;users&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€çµ‚çµæœ:\n&quot;</span> &lt;&lt; result &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼åœæ­¢</span></div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(2));</div>
<div class="line">        db.stop();</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md304"></a>
ğŸ› ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</h1>
<h2><a class="anchor" id="autotoc_md305"></a>
1. éåŒæœŸå‡¦ç†ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;future&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>AsyncServiceClient {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    ServiceClient&lt;RequestType, ResponseType&gt; client_;</div>
<div class="line">    std::unordered_map&lt;uint64_t, std::future&lt;ResponseType&gt;&gt; pending_requests_;</div>
<div class="line">    std::mutex requests_mutex_;</div>
<div class="line">    std::atomic&lt;uint64_t&gt; request_counter_{0};</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    AsyncServiceClient(<span class="keyword">const</span> std::string&amp; service_name) : client_(service_name) {}</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// éåŒæœŸè¦æ±‚é€ä¿¡</span></div>
<div class="line">    uint64_t sendRequestAsync(<span class="keyword">const</span> RequestType&amp; request) {</div>
<div class="line">        uint64_t request_id = request_counter_++;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</span></div>
<div class="line">        <span class="keyword">auto</span> future = std::async(std::launch::async, [<span class="keyword">this</span>, request]() {</div>
<div class="line">            client_.sendRequest(request);</div>
<div class="line">            <span class="keywordflow">if</span> (client_.waitForResponse(5000000)) {  <span class="comment">// 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">                return client_.getResponse();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Request timeout&quot;</span>);</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        {</div>
<div class="line">            std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">            pending_requests_[request_id] = std::move(future);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> request_id;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// å¿œç­”ç¢ºèªï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰</span></div>
<div class="line">    <span class="keywordtype">bool</span> checkResponse(uint64_t request_id, ResponseType&amp; response) {</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> it = pending_requests_.find(request_id);</div>
<div class="line">        <span class="keywordflow">if</span> (it == pending_requests_.end()) {</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// å®Œäº†ç¢ºèª</span></div>
<div class="line">        <span class="keywordflow">if</span> (it-&gt;second.wait_for(std::chrono::seconds(0)) == std::future_status::ready) {</div>
<div class="line">            <span class="keywordflow">try</span> {</div>
<div class="line">                response = it-&gt;second.get();</div>
<div class="line">                pending_requests_.erase(it);</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">                pending_requests_.erase(it);</div>
<div class="line">                <span class="keywordflow">throw</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// å¿œç­”å¾…æ©Ÿï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰</span></div>
<div class="line">    ResponseType waitForResponse(uint64_t request_id, </div>
<div class="line">                                std::chrono::milliseconds timeout = std::chrono::milliseconds(5000)) {</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> it = pending_requests_.find(request_id);</div>
<div class="line">        <span class="keywordflow">if</span> (it == pending_requests_.end()) {</div>
<div class="line">            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Request not found&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãå¾…æ©Ÿ</span></div>
<div class="line">        <span class="keywordflow">if</span> (it-&gt;second.wait_for(timeout) == std::future_status::ready) {</div>
<div class="line">            <span class="keywordflow">try</span> {</div>
<div class="line">                ResponseType response = it-&gt;second.get();</div>
<div class="line">                pending_requests_.erase(it);</div>
<div class="line">                <span class="keywordflow">return</span> response;</div>
<div class="line">            } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">                pending_requests_.erase(it);</div>
<div class="line">                <span class="keywordflow">throw</span>;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            pending_requests_.erase(it);</div>
<div class="line">            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Request timeout&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ä¸€æ‹¬è¦æ±‚é€ä¿¡</span></div>
<div class="line">    std::vector&lt;uint64_t&gt; sendBatchRequests(<span class="keyword">const</span> std::vector&lt;RequestType&gt;&amp; requests) {</div>
<div class="line">        std::vector&lt;uint64_t&gt; request_ids;</div>
<div class="line">        request_ids.reserve(requests.size());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; request : requests) {</div>
<div class="line">            request_ids.push_back(sendRequestAsync(request));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> request_ids;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ä¸€æ‹¬å¿œç­”å—ä¿¡</span></div>
<div class="line">    std::vector&lt;ResponseType&gt; waitForBatchResponses(<span class="keyword">const</span> std::vector&lt;uint64_t&gt;&amp; request_ids,</div>
<div class="line">                                                   std::chrono::milliseconds timeout = std::chrono::milliseconds(5000)) {</div>
<div class="line">        std::vector&lt;ResponseType&gt; responses;</div>
<div class="line">        responses.reserve(request_ids.size());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (uint64_t request_id : request_ids) {</div>
<div class="line">            responses.push_back(waitForResponse(request_id, timeout));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> responses;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ä¿ç•™ä¸­ã®è¦æ±‚æ•°</span></div>
<div class="line">    <span class="keywordtype">size_t</span> getPendingRequestCount()<span class="keyword"> const </span>{</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(requests_mutex_);</div>
<div class="line">        <span class="keywordflow">return</span> pending_requests_.size();</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md306"></a>
2. æ¥ç¶šãƒ—ãƒ¼ãƒ«ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>ServiceConnectionPool {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::vector&lt;std::unique_ptr&lt;ServiceClient&lt;RequestType, ResponseType&gt;&gt;&gt; clients_;</div>
<div class="line">    std::atomic&lt;size_t&gt; round_robin_index_{0};</div>
<div class="line">    std::mutex pool_mutex_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    ServiceConnectionPool(<span class="keyword">const</span> std::string&amp; service_name, <span class="keywordtype">size_t</span> pool_size = 4) {</div>
<div class="line">        clients_.reserve(pool_size);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; pool_size; ++i) {</div>
<div class="line">            clients_.push_back(std::make_unique&lt;ServiceClient&lt;RequestType, ResponseType&gt;&gt;(service_name));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³æ–¹å¼ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé¸æŠ</span></div>
<div class="line">    ResponseType sendRequestRoundRobin(<span class="keyword">const</span> RequestType&amp; request) {</div>
<div class="line">        <span class="keywordtype">size_t</span> index = round_robin_index_++ % clients_.size();</div>
<div class="line">        <span class="keywordflow">return</span> sendRequestToClient(index, request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// æœ€ã‚‚è² è·ã®å°‘ãªã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é¸æŠ</span></div>
<div class="line">    ResponseType sendRequestLeastLoaded(<span class="keyword">const</span> RequestType&amp; request) {</div>
<div class="line">        <span class="comment">// å®Ÿè£…ã§ã¯å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è² è·ã‚’ç›£è¦–</span></div>
<div class="line">        <span class="comment">// ã“ã®ä¾‹ã§ã¯ç°¡ç•¥åŒ–ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ</span></div>
<div class="line">        <span class="keywordtype">size_t</span> index = rand() % clients_.size();</div>
<div class="line">        <span class="keywordflow">return</span> sendRequestToClient(index, request);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ä¸¦åˆ—è¦æ±‚å‡¦ç†</span></div>
<div class="line">    std::vector&lt;ResponseType&gt; sendParallelRequests(<span class="keyword">const</span> std::vector&lt;RequestType&gt;&amp; requests) {</div>
<div class="line">        std::vector&lt;std::future&lt;ResponseType&gt;&gt; futures;</div>
<div class="line">        futures.reserve(requests.size());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; requests.size(); ++i) {</div>
<div class="line">            <span class="keywordtype">size_t</span> client_index = i % clients_.size();</div>
<div class="line">            </div>
<div class="line">            futures.push_back(std::async(std::launch::async, [<span class="keyword">this</span>, client_index, &amp;requests, i]() {</div>
<div class="line">                <span class="keywordflow">return</span> sendRequestToClient(client_index, requests[i]);</div>
<div class="line">            }));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::vector&lt;ResponseType&gt; responses;</div>
<div class="line">        responses.reserve(requests.size());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; future : futures) {</div>
<div class="line">            responses.push_back(future.get());</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> responses;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    ResponseType sendRequestToClient(<span class="keywordtype">size_t</span> client_index, <span class="keyword">const</span> RequestType&amp; request) {</div>
<div class="line">        std::lock_guard&lt;std::mutex&gt; lock(pool_mutex_);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span>&amp; client = clients_[client_index];</div>
<div class="line">        client-&gt;sendRequest(request);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (client-&gt;waitForResponse(5000000)) {  <span class="comment">// 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">            <span class="keywordflow">return</span> client-&gt;getResponse();</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Service request timeout&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md307"></a>
ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã¨ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h1>
<h2><a class="anchor" id="autotoc_md308"></a>
è©³ç´°ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ServicePerformanceBenchmark {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::vector&lt;double&gt; latencies_;</div>
<div class="line">    std::vector&lt;double&gt; throughputs_;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> runServiceBenchmark() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== Serviceé€šä¿¡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯é–‹å§‹ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 1. ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        measureLatency();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 2. ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        measureThroughput();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 3. åŒæ™‚æ¥ç¶šãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        measureConcurrency();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 4. é•·æ™‚é–“ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        measureLongTermStability();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> measureLatency() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¸¬å®šä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        ServiceServer&lt;int, int&gt; server(<span class="stringliteral">&quot;latency_test&quot;</span>);</div>
<div class="line">        ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;latency_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread server_thread([&amp;server]() {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">                <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">                    int request = server.getRequest();</div>
<div class="line">                    server.sendResponse(request * 2);</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        latencies_.clear();</div>
<div class="line">        latencies_.reserve(1000);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¸¬å®š</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">            <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::now();</div>
<div class="line">            </div>
<div class="line">            client.sendRequest(i);</div>
<div class="line">            <span class="keywordflow">if</span> (client.waitForResponse(1000000)) {  <span class="comment">// 1ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">                <span class="keywordtype">int</span> response = client.getResponse();</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::now();</div>
<div class="line">                <span class="keyword">auto</span> latency = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</div>
<div class="line">                    end - start).count();</div>
<div class="line">                </div>
<div class="line">                latencies_.push_back(latency);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        server_thread.join();</div>
<div class="line">        analyzeLatency();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> measureThroughput() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆæ¸¬å®šä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        ServiceServer&lt;std::vector&lt;int&gt;, std::vector&lt;int&gt;&gt; server(<span class="stringliteral">&quot;throughput_test&quot;</span>);</div>
<div class="line">        ServiceClient&lt;std::vector&lt;int&gt;, std::vector&lt;int&gt;&gt; client(<span class="stringliteral">&quot;throughput_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        std::vector&lt;size_t&gt; data_sizes = {10, 100, 1000, 10000};</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> size : data_sizes) {</div>
<div class="line">            measureThroughputForSize(server, client, size);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> measureThroughputForSize(ServiceServer&lt;std::vector&lt;int&gt;, std::vector&lt;int&gt;&gt;&amp; server,</div>
<div class="line">                                 ServiceClient&lt;std::vector&lt;int&gt;, std::vector&lt;int&gt;&gt;&amp; client,</div>
<div class="line">                                 <span class="keywordtype">size_t</span> data_size) {</div>
<div class="line">        </div>
<div class="line">        std::vector&lt;int&gt; test_data(data_size);</div>
<div class="line">        std::iota(test_data.begin(), test_data.end(), 1);</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> iterations = 100;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread server_thread([&amp;server, iterations]() {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; iterations; ++i) {</div>
<div class="line">                <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">                    auto request = server.getRequest();</div>
<div class="line">                    <span class="comment">// ç°¡å˜ãªå‡¦ç†ï¼ˆè¦ç´ ã®2å€ï¼‰</span></div>
<div class="line">                    for (auto&amp; val : request) {</div>
<div class="line">                        val *= 2;</div>
<div class="line">                    }</div>
<div class="line">                    server.sendResponse(request);</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::now();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¸¬å®š</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; iterations; ++i) {</div>
<div class="line">            client.sendRequest(test_data);</div>
<div class="line">            <span class="keywordflow">if</span> (client.waitForResponse(5000000)) {  <span class="comment">// 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">                <span class="keyword">auto</span> response = client.getResponse();</div>
<div class="line">                <span class="comment">// å¿œç­”ç¢ºèª</span></div>
<div class="line">                assert(response.size() == data_size);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::now();</div>
<div class="line">        server_thread.join();</div>
<div class="line">        </div>
<div class="line">        <span class="keyword">auto</span> duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</div>
<div class="line">            end - start).count();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">double</span> throughput = (double)(iterations * data_size * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)) / duration / 1024.0;  <span class="comment">// KB/s</span></div>
<div class="line">        <span class="keywordtype">double</span> message_rate = (double)iterations / duration * 1000.0;  <span class="comment">// msg/s</span></div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º &quot;</span> &lt;&lt; data_size &lt;&lt; <span class="stringliteral">&quot; è¦ç´ :&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::setprecision(1) </div>
<div class="line">                  &lt;&lt; throughput &lt;&lt; <span class="stringliteral">&quot; KB/s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¬ãƒ¼ãƒˆ: &quot;</span> &lt;&lt; std::setprecision(0) </div>
<div class="line">                  &lt;&lt; message_rate &lt;&lt; <span class="stringliteral">&quot; msg/s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> measureConcurrency() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;åŒæ™‚æ¥ç¶šæ€§èƒ½æ¸¬å®šä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        ServiceServer&lt;int, int&gt; server(<span class="stringliteral">&quot;concurrency_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread server_thread([&amp;server]() {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">                <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">                    int request = server.getRequest();</div>
<div class="line">                    <span class="comment">// è¨ˆç®—è² è·ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</span></div>
<div class="line">                    std::this_thread::sleep_for(std::chrono::microseconds(100));</div>
<div class="line">                    server.sendResponse(request + 1);</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        std::vector&lt;int&gt; client_counts = {1, 2, 4, 8, 16};</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> client_count : client_counts) {</div>
<div class="line">            <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::now();</div>
<div class="line">            </div>
<div class="line">            std::vector&lt;std::thread&gt; client_threads;</div>
<div class="line">            std::atomic&lt;int&gt; completed_requests{0};</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; client_count; ++i) {</div>
<div class="line">                client_threads.emplace_back([&amp;completed_requests, i]() {</div>
<div class="line">                    ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;concurrency_test&quot;</span>);</div>
<div class="line">                    </div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 10; ++j) {</div>
<div class="line">                        client.sendRequest(i * 10 + j);</div>
<div class="line">                        <span class="keywordflow">if</span> (client.waitForResponse(2000000)) {  <span class="comment">// 2ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">                            completed_requests++;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                });</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; thread : client_threads) {</div>
<div class="line">                thread.join();</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::now();</div>
<div class="line">            <span class="keyword">auto</span> duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</div>
<div class="line">                end - start).count();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordtype">double</span> reqs_per_sec = (double)completed_requests / duration * 1000.0;</div>
<div class="line">            </div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;åŒæ™‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•° &quot;</span> &lt;&lt; client_count &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  å®Œäº†è¦æ±‚æ•°: &quot;</span> &lt;&lt; completed_requests &lt;&lt; std::endl;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  è¦æ±‚/ç§’: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::setprecision(1) </div>
<div class="line">                      &lt;&lt; reqs_per_sec &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        server_thread.join();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> measureLongTermStability() {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;é•·æœŸå®‰å®šæ€§æ¸¬å®šä¸­...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        ServiceServer&lt;int, int&gt; server(<span class="stringliteral">&quot;stability_test&quot;</span>);</div>
<div class="line">        ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;stability_test&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        std::atomic&lt;bool&gt; running{<span class="keyword">true</span>};</div>
<div class="line">        std::atomic&lt;int&gt; success_count{0};</div>
<div class="line">        std::atomic&lt;int&gt; failure_count{0};</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚µãƒ¼ãƒãƒ¼å´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread server_thread([&amp;server, &amp;running]() {</div>
<div class="line">            <span class="keywordflow">while</span> (running) {</div>
<div class="line">                <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">                    int request = server.getRequest();</div>
<div class="line">                    server.sendResponse(request);</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(100));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
<div class="line">        std::thread client_thread([&amp;client, &amp;running, &amp;success_count, &amp;failure_count]() {</div>
<div class="line">            <span class="keywordtype">int</span> request_id = 0;</div>
<div class="line">            <span class="keywordflow">while</span> (running) {</div>
<div class="line">                client.sendRequest(request_id++);</div>
<div class="line">                <span class="keywordflow">if</span> (client.waitForResponse(1000000)) {  <span class="comment">// 1ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">                    success_count++;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    failure_count++;</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::milliseconds(10));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 30ç§’é–“å®Ÿè¡Œ</span></div>
<div class="line">        std::this_thread::sleep_for(std::chrono::seconds(30));</div>
<div class="line">        running = <span class="keyword">false</span>;</div>
<div class="line">        </div>
<div class="line">        server_thread.join();</div>
<div class="line">        client_thread.join();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> total_requests = success_count + failure_count;</div>
<div class="line">        <span class="keywordtype">double</span> success_rate = (double)success_count / total_requests * 100.0;</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;é•·æœŸå®‰å®šæ€§çµæœ:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  ç·è¦æ±‚æ•°: &quot;</span> &lt;&lt; total_requests &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  æˆåŠŸæ•°: &quot;</span> &lt;&lt; success_count &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  å¤±æ•—æ•°: &quot;</span> &lt;&lt; failure_count &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  æˆåŠŸç‡: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::setprecision(2) </div>
<div class="line">                  &lt;&lt; success_rate &lt;&lt; <span class="stringliteral">&quot;%&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> analyzeLatency() {</div>
<div class="line">        <span class="keywordflow">if</span> (latencies_.empty()) <span class="keywordflow">return</span>;</div>
<div class="line">        </div>
<div class="line">        std::sort(latencies_.begin(), latencies_.end());</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">double</span> mean = std::accumulate(latencies_.begin(), latencies_.end(), 0.0) / latencies_.size();</div>
<div class="line">        <span class="keywordtype">double</span> min_val = latencies_.front();</div>
<div class="line">        <span class="keywordtype">double</span> max_val = latencies_.back();</div>
<div class="line">        <span class="keywordtype">double</span> p50 = latencies_[latencies_.size() * 0.5];</div>
<div class="line">        <span class="keywordtype">double</span> p95 = latencies_[latencies_.size() * 0.95];</div>
<div class="line">        <span class="keywordtype">double</span> p99 = latencies_[latencies_.size() * 0.99];</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== Serviceé€šä¿¡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆ (Î¼s) ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; std::fixed &lt;&lt; std::setprecision(2);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;å¹³å‡: &quot;</span> &lt;&lt; mean &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€å°: &quot;</span> &lt;&lt; min_val &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€å¤§: &quot;</span> &lt;&lt; max_val &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;50%ile: &quot;</span> &lt;&lt; p50 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;95%ile: &quot;</span> &lt;&lt; p95 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;99%ile: &quot;</span> &lt;&lt; p99 &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (p99 &lt; 100.0) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ğŸ† å„ªç§€: 99%ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ100Î¼sä»¥ä¸‹&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p99 &lt; 1000.0) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ğŸ‘ è‰¯å¥½: 99%ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ1msä»¥ä¸‹&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;âš ï¸  è¦æ”¹å–„: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒé«˜ã‚ã§ã™&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ</span></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        ServicePerformanceBenchmark benchmark;</div>
<div class="line">        benchmark.runServiceBenchmark();</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md309"></a>
â“ ã‚ˆãã‚ã‚‹è³ªå•</h1>
<h2><a class="anchor" id="autotoc_md310"></a>
Q1. è¦æ±‚ã«å¯¾ã™ã‚‹å¿œç­”ãŒè¿”ã£ã¦ã“ãªã„å ´åˆã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>: ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š</p><ul>
<li>ã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹</li>
<li>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ãŒé©åˆ‡ã‹</li>
<li>ã‚µãƒ¼ãƒãƒ¼å´ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹</li>
<li>ãƒˆãƒ”ãƒƒã‚¯åãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹</li>
</ul>
<h2><a class="anchor" id="autotoc_md311"></a>
Q2. è¤‡æ•°ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåŒæ™‚ã«è¦æ±‚ã—ãŸå ´åˆã®å‡¦ç†é †åºã¯ï¼Ÿ</h2>
<p><b>A</b>: åŸºæœ¬çš„ã«FIFOï¼ˆå…ˆå…¥ã‚Œå…ˆå‡ºã—ï¼‰ã§å‡¦ç†ã•ã‚Œã¾ã™ãŒã€ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚å„ªå…ˆåº¦ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¥ãƒ¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚</p>
<h2><a class="anchor" id="autotoc_md312"></a>
Q3. ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚å†æ¥ç¶šæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€è‡ªå‹•çš„ã«å¾©æ—§ã§ãã¾ã™ã€‚</p>
<h2><a class="anchor" id="autotoc_md313"></a>
Q4. å¤§ããªãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ</h2>
<p><b>A</b>: å¯èƒ½ã§ã™ãŒã€å…±æœ‰ãƒ¡ãƒ¢ãƒªã®ã‚µã‚¤ã‚ºåˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯åˆ†å‰²ã—ã¦é€ä¿¡ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§äº¤æ›ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p>
<h1><a class="anchor" id="autotoc_md314"></a>
ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h1>
<h2><a class="anchor" id="autotoc_md315"></a>
ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•</h2>
<div class="fragment"><div class="line"><span class="comment">// Serviceé€šä¿¡è¨ºæ–­ãƒ„ãƒ¼ãƒ«</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__service_8hpp.html">shm_service.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> diagnose_service_communication() {</div>
<div class="line">    <span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;=== Serviceé€šä¿¡è¨ºæ–­ ===&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="comment">// 1. ã‚µãƒ¼ãƒãƒ¼ä½œæˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        ServiceServer&lt;int, int&gt; server(<span class="stringliteral">&quot;diagnostic_service&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… ã‚µãƒ¼ãƒãƒ¼ä½œæˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;diagnostic_service&quot;</span>);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// 3. é€šä¿¡ãƒ†ã‚¹ãƒˆ</span></div>
<div class="line">        std::thread server_thread([&amp;server]() {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; ++i) {</div>
<div class="line">                <span class="keywordflow">if</span> (server.hasRequest()) {</div>
<div class="line">                    int request = server.getRequest();</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚µãƒ¼ãƒãƒ¼: è¦æ±‚å—ä¿¡ &quot;</span> &lt;&lt; request &lt;&lt; std::endl;</div>
<div class="line">                    server.sendResponse(request * 2);</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚µãƒ¼ãƒãƒ¼: å¿œç­”é€ä¿¡ &quot;</span> &lt;&lt; (request * 2) &lt;&lt; std::endl;</div>
<div class="line">                }</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(50));</div>
<div class="line">        </div>
<div class="line">        client.sendRequest(21);</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: è¦æ±‚é€ä¿¡ 21&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (client.waitForResponse(2000000)) {  <span class="comment">// 2ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</span></div>
<div class="line">            <span class="keywordtype">int</span> response = client.getResponse();</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: å¿œç­”å—ä¿¡ &quot;</span> &lt;&lt; response &lt;&lt; std::endl;</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (response == 42) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;âœ… é€šä¿¡ãƒ†ã‚¹ãƒˆæˆåŠŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;âŒ é€šä¿¡ãƒ†ã‚¹ãƒˆå¤±æ•—: æœŸå¾…å€¤42ã€å®Ÿéš›å€¤&quot;</span> &lt;&lt; response &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;âŒ é€šä¿¡ãƒ†ã‚¹ãƒˆå¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        server_thread.join();</div>
<div class="line">        </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;âŒ è¨ºæ–­ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - å…±æœ‰ãƒ¡ãƒ¢ãƒªã®æ¨©é™è¨­å®š&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ä¸­ã§ãªã„ã‹&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³</span></div>
<div class="line"><span class="keywordtype">void</span> robust_service_client_example() {</div>
<div class="line">    <span class="keyword">using namespace </span>irlab::shm;</div>
<div class="line">    </div>
<div class="line">    ServiceClient&lt;int, int&gt; client(<span class="stringliteral">&quot;robust_service&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> MAX_RETRIES = 3;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> TIMEOUT_MS = 5000;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> retry = 0; retry &lt; MAX_RETRIES; ++retry) {</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;è¦æ±‚é€ä¿¡ (è©¦è¡Œ &quot;</span> &lt;&lt; (retry + 1) &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; MAX_RETRIES &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            </div>
<div class="line">            client.sendRequest(42);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (client.waitForResponse(TIMEOUT_MS * 1000)) {  <span class="comment">// ãƒã‚¤ã‚¯ãƒ­ç§’ã«å¤‰æ›</span></div>
<div class="line">                <span class="keywordtype">int</span> response = client.getResponse();</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;æˆåŠŸ: å¿œç­”å—ä¿¡ &quot;</span> &lt;&lt; response &lt;&lt; std::endl;</div>
<div class="line">                <span class="keywordflow">return</span>;  <span class="comment">// æˆåŠŸ</span></div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å†è©¦è¡Œã—ã¾ã™...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;ã‚¨ãƒ©ãƒ¼: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (retry &lt; MAX_RETRIES - 1) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;å†è©¦è¡Œã—ã¾ã™...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::seconds(1));</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;æœ€å¤§å†è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                <span class="keywordflow">throw</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md316"></a>
ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h1>
<p>Serviceé€šä¿¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸã‚‰ã€ä»¥ä¸‹ã®é«˜åº¦ãªãƒˆãƒ”ãƒƒã‚¯ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p>
<ol type="1">
<li><b><a class="el" href="md_manual_tutorials_shm_pub_sub_jp.html">ğŸ“¡ Pub/Subé€šä¿¡</a></b> - é«˜é€Ÿãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€šä¿¡</li>
<li><b><a class="el" href="md_manual_tutorials_shm_action_jp.html">âš¡ Actioné€šä¿¡</a></b> - é•·æ™‚é–“éåŒæœŸå‡¦ç†</li>
<li><b><a class="el" href="md_manual_tutorials_python_jp.html">ğŸ Pythoné€£æº</a></b> - Pythonã§Serviceé€šä¿¡</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md318"></a>
ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±</h1>
<p>æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€shared-memory-based-handy-communication-manager ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦ <b>Apache License 2.0</b> ã®ä¸‹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<ul>
<li>âœ… <b>å•†ç”¨åˆ©ç”¨å¯èƒ½</b>: ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å•†æ¥­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è‡ªç”±ã«ä½¿ç”¨</li>
<li>âœ… <b>æ”¹å¤‰å¯èƒ½</b>: ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ãƒ»æ‹¡å¼µ</li>
<li>âœ… <b>å†é…å¸ƒå¯èƒ½</b>: ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨ç¤ºã‚’ä¿æŒã—ã¦å†é…å¸ƒ</li>
</ul>
<p>è©³ç´°ã¯<a href="../LICENSE">LICENSEãƒ•ã‚¡ã‚¤ãƒ«</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
<hr  />
<p>ã“ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã§ã€Serviceé€šä¿¡ã®åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã€ä¿¡é ¼æ€§ã®é«˜ã„åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†ï¼ ğŸš€âœ¨ </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jul 5 2025 13:54:48 for SHM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
