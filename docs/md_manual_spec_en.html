<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHM: 📋 SHM Technical Specification - Complete System Architecture Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SHM
   </div>
   <div id="projectbrief">Shared-memory based Handy-communication Manager</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">📋 SHM Technical Specification - Complete System Architecture Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md106">🎯 Purpose</a></li>
<li class="level1"><a href="#autotoc_md107">📖 Abstract</a><ul><li class="level2"><a href="#autotoc_md108">Framework Context</a></li>
<li class="level2"><a href="#autotoc_md109">🚀 System Functions</a><ul><li class="level3"><a href="#autotoc_md110">Memory Management Process Hiding</a></li>
<li class="level3"><a href="#autotoc_md111">Pointer-Free Coding</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md112">👥 User Characteristics</a><ul><li class="level3"><a href="#autotoc_md113">🎓 Developer</a></li>
<li class="level3"><a href="#autotoc_md114">🏗️ Designer</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md115">📚 Definitions and Terms</a><ul><li class="level3"><a href="#autotoc_md116">Local Memory</a></li>
<li class="level3"><a href="#autotoc_md117">Shared Memory</a></li>
<li class="level3"><a href="#autotoc_md118">Standard Layout Type</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md119">🏗️ Architecture Design</a><ul><li class="level2"><a href="#autotoc_md120">Overall System Architecture</a></li>
<li class="level2"><a href="#autotoc_md121">Layer Architecture</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md122">🔧 Detailed Design</a><ul><li class="level2"><a href="#autotoc_md123">Class Hierarchy Structure</a></li>
<li class="level2"><a href="#autotoc_md124">Shared Memory Layout</a></li>
<li class="level2"><a href="#autotoc_md125">Data Flow</a><ul><li class="level3"><a href="#autotoc_md126">Publish Process Flow</a></li>
<li class="level3"><a href="#autotoc_md127">Subscribe Process Flow</a></li>
<li class="level3"><a href="#autotoc_md128">waitFor Process Flow</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md129">📡 Communication Protocol</a><ul><li class="level2"><a href="#autotoc_md130">Ring Buffer Algorithm</a><ul><li class="level3"><a href="#autotoc_md131">Buffer Selection Algorithm</a></li>
<li class="level3"><a href="#autotoc_md132">Data Reading Algorithm</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md133">Synchronization Mechanism</a><ul><li class="level3"><a href="#autotoc_md134">Mutex and Condition Variable</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md135">⚡ Performance Characteristics</a><ul><li class="level2"><a href="#autotoc_md136">Memory Usage</a></li>
<li class="level2"><a href="#autotoc_md137">Latency Characteristics</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md138">🔒 Security Considerations</a><ul><li class="level2"><a href="#autotoc_md139">Access Permissions</a></li>
<li class="level2"><a href="#autotoc_md140">Data Integrity</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md141">❌ Error Handling</a><ul><li class="level2"><a href="#autotoc_md142">Error Classification and Response</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md143">🐍 Python Binding Design</a><ul><li class="level2"><a href="#autotoc_md144">Boost.Python Wrapper Structure</a></li>
<li class="level2"><a href="#autotoc_md145">Python/C++ Data Conversion</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md146">🔧 Extensibility Considerations</a><ul><li class="level2"><a href="#autotoc_md147">Adding New Data Types</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md148">📚 References</a><ul><li class="level2"><a href="#autotoc_md149">man shm_overview</a></li>
<li class="level2"><a href="#autotoc_md150">Related Technical Specifications</a></li>
<li class="level2"><a href="#autotoc_md151">Additional Resources</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>[English | <a href="docs_jp/md_manual_spec_jp.html">日本語</a>]</p>
<h1><a class="anchor" id="autotoc_md106"></a>
🎯 Purpose</h1>
<p>The purpose of SHM (Shared-memory based Handy-communication Manager) is to provide the most secure and fastest possible communication between different processes. It is also designed with careful consideration to make it easy for students to use. Please refer to README.md for installation instructions.</p>
<h1><a class="anchor" id="autotoc_md107"></a>
📖 Abstract</h1>
<h2><a class="anchor" id="autotoc_md108"></a>
Framework Context</h2>
<p>The Instrumentation and Robotics Laboratory at Utsunomiya University uses shared memory for data exchange between programs, in addition to local memory generally used by programs.</p>
<p>Shared memory differs from local memory in several key aspects:</p><ul>
<li><b>Memory Management</b>: Developers must not release allocated memory (inadvertent release prevents data passing to other programs)</li>
<li><b>Programming Complexity</b>: Higher barrier for novice programmers due to pointer usage</li>
<li><b>Development Overhead</b>: Designers must create custom processes for each memory type when creating new libraries</li>
</ul>
<p>This framework <b>hides data exchange using shared memory</b> and provides <b>easy-to-understand inter-process communication</b> for novice programmers.</p>
<h2><a class="anchor" id="autotoc_md109"></a>
🚀 System Functions</h2>
<h3><a class="anchor" id="autotoc_md110"></a>
Memory Management Process Hiding</h3>
<p>Easy inter-process communication is achieved by hiding shared memory area allocation and buffer access within classes. By default, only <b>standard layout type classes</b> are supported. Other classes can be supported by defining specialized Publishers/Subscribers for each case. See samples for details.</p>
<h3><a class="anchor" id="autotoc_md111"></a>
Pointer-Free Coding</h3>
<p>The system fundamentally only requires passing variables allocated in local memory to Publishers or receiving topics from Subscribers, <b>eliminating the need to code with shared memory pointers</b> as in traditional approaches.</p>
<h2><a class="anchor" id="autotoc_md112"></a>
👥 User Characteristics</h2>
<h3><a class="anchor" id="autotoc_md113"></a>
🎓 Developer</h3>
<p>Developers create new programs using internal and external libraries, including this library. Primarily intended for <b>first-time programming students</b> such as fourth-year undergraduates.</p>
<h3><a class="anchor" id="autotoc_md114"></a>
🏗️ Designer</h3>
<p>Designers create new libraries using this framework and transfer current know-how to junior members. Primarily intended for <b>second-year master students</b>.</p>
<h2><a class="anchor" id="autotoc_md115"></a>
📚 Definitions and Terms</h2>
<h3><a class="anchor" id="autotoc_md116"></a>
Local Memory</h3>
<p>Local memory is a <b>virtual storage area accessible within a process</b>. It's the storage area used during normal programming. If not properly released after use, it may cause future problems (programs working correctly for a while may suddenly stop).</p>
<h3><a class="anchor" id="autotoc_md117"></a>
Shared Memory</h3>
<p>Shared memory is a <b>storage area that can be used commonly among processes</b>. It's allocated by special means and can be implemented in various ways. This implementation uses <b>POSIX file-mapped memory</b>, where data stored in shared memory is treated as a file. In Linux, the allocated memory area can be confirmed directly under <code>/dev/shm</code>.</p>
<h3><a class="anchor" id="autotoc_md118"></a>
Standard Layout Type</h3>
<p>A class or structure that:</p><ul>
<li>Contains no specific C++ language features (like virtual functions) not found in C</li>
<li>Has all members with the same access control</li>
<li>Enables <code>memcpy</code> operations</li>
<li>Has clearly defined layout for use in C programs</li>
</ul>
<p><b>Standard layout types have the following characteristics:</b></p><ul>
<li>No virtual functions or virtual base classes</li>
<li>All non-static data members have the same access control</li>
<li>All non-static members of class type are standard layout</li>
<li>All base classes have standard layout</li>
<li>No base class of the same type as the first non-static data member</li>
<li>Meets one of the following conditions:<ul>
<li>The most derived class has no non-static data members and only one base class with non-static data members</li>
<li>No base class contains non-static data members</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md119"></a>
🏗️ Architecture Design</h1>
<h2><a class="anchor" id="autotoc_md120"></a>
Overall System Architecture</h2>
<div class="fragment"><div class="line">graph TB</div>
<div class="line">    subgraph &quot;Process A&quot;</div>
<div class="line">        PA[Application A]</div>
<div class="line">        PubA[Publisher A]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Process B&quot;</div>
<div class="line">        PB[Application B]</div>
<div class="line">        SubB[Subscriber B]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Process C&quot;</div>
<div class="line">        PC[Application C]</div>
<div class="line">        SubC[Subscriber C]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Shared Memory Area&quot;</div>
<div class="line">        SM[Shared Memory Segment]</div>
<div class="line">        RB[Ring Buffer]</div>
<div class="line">        Meta[Metadata]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    PA --&gt; PubA</div>
<div class="line">    PubA --&gt; SM</div>
<div class="line">    SM --&gt; RB</div>
<div class="line">    RB --&gt; SubB</div>
<div class="line">    RB --&gt; SubC</div>
<div class="line">    SubB --&gt; PB</div>
<div class="line">    SubC --&gt; PC</div>
<div class="line">    </div>
<div class="line">    SM --&gt; Meta</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md121"></a>
Layer Architecture</h2>
<div class="fragment"><div class="line">graph TB</div>
<div class="line">    subgraph &quot;Application Layer&quot;</div>
<div class="line">        APP[User Application]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;SHM API Layer&quot;</div>
<div class="line">        PUB[Publisher&lt;T&gt;]</div>
<div class="line">        SUB[Subscriber&lt;T&gt;]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Shared Memory Management Layer&quot;</div>
<div class="line">        SHM[SharedMemory]</div>
<div class="line">        POSIX[SharedMemoryPosix]</div>
<div class="line">        RB[RingBuffer]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;OS Layer&quot;</div>
<div class="line">        KERNEL[Linux Kernel]</div>
<div class="line">        SHMFS[/dev/shm Filesystem]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    APP --&gt; PUB</div>
<div class="line">    APP --&gt; SUB</div>
<div class="line">    PUB --&gt; SHM</div>
<div class="line">    SUB --&gt; SHM</div>
<div class="line">    SHM --&gt; POSIX</div>
<div class="line">    POSIX --&gt; RB</div>
<div class="line">    POSIX --&gt; KERNEL</div>
<div class="line">    KERNEL --&gt; SHMFS</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md122"></a>
🔧 Detailed Design</h1>
<h2><a class="anchor" id="autotoc_md123"></a>
Class Hierarchy Structure</h2>
<div class="fragment"><div class="line">classDiagram</div>
<div class="line">    class SharedMemory {</div>
<div class="line">        &lt;&lt;abstract&gt;&gt;</div>
<div class="line">        #int shm_fd</div>
<div class="line">        #int shm_oflag</div>
<div class="line">        #PERM shm_perm</div>
<div class="line">        #size_t shm_size</div>
<div class="line">        #unsigned char* shm_ptr</div>
<div class="line">        +SharedMemory(int oflag, PERM perm)</div>
<div class="line">        +getSize() size_t</div>
<div class="line">        +getPtr() unsigned char*</div>
<div class="line">        +connect(size_t size)* bool</div>
<div class="line">        +disconnect()* int</div>
<div class="line">        +isDisconnected()* bool</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class SharedMemoryPosix {</div>
<div class="line">        -string shm_name</div>
<div class="line">        +SharedMemoryPosix(string name, int oflag, PERM perm)</div>
<div class="line">        +connect(size_t size) bool</div>
<div class="line">        +disconnect() int</div>
<div class="line">        +isDisconnected() bool</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class RingBuffer {</div>
<div class="line">        -unsigned char* memory_ptr</div>
<div class="line">        -pthread_mutex_t* mutex</div>
<div class="line">        -pthread_cond_t* condition</div>
<div class="line">        -size_t* element_size</div>
<div class="line">        -size_t* buf_num</div>
<div class="line">        -atomic~uint64_t~* timestamp_list</div>
<div class="line">        -unsigned char* data_list</div>
<div class="line">        -uint64_t timestamp_us</div>
<div class="line">        -uint64_t data_expiry_time_us</div>
<div class="line">        +RingBuffer(unsigned char* first_ptr, size_t size, int buffer_num)</div>
<div class="line">        +getSize(size_t element_size, int buffer_num)$ size_t</div>
<div class="line">        +getTimestamp_us() uint64_t</div>
<div class="line">        +setTimestamp_us(uint64_t input_time_us, int buffer_num)</div>
<div class="line">        +getNewestBufferNum() int</div>
<div class="line">        +getOldestBufferNum() int</div>
<div class="line">        +allocateBuffer(int buffer_num) bool</div>
<div class="line">        +getElementSize() size_t</div>
<div class="line">        +getDataList() unsigned char*</div>
<div class="line">        +signal()</div>
<div class="line">        +waitFor(uint64_t timeout_usec) bool</div>
<div class="line">        +isUpdated() bool</div>
<div class="line">        +setDataExpiryTime_us(uint64_t time_us)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class Publisher~T~ {</div>
<div class="line">        -string shm_name</div>
<div class="line">        -int shm_buf_num</div>
<div class="line">        -PERM shm_perm</div>
<div class="line">        -unique_ptr~SharedMemory~ shared_memory</div>
<div class="line">        -unique_ptr~RingBuffer~ ring_buffer</div>
<div class="line">        -size_t data_size</div>
<div class="line">        +Publisher(string name, int buffer_num, PERM perm)</div>
<div class="line">        +publish(const T&amp; data)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class Subscriber~T~ {</div>
<div class="line">        -string shm_name</div>
<div class="line">        -unique_ptr~SharedMemory~ shared_memory</div>
<div class="line">        -unique_ptr~RingBuffer~ ring_buffer</div>
<div class="line">        -int current_reading_buffer</div>
<div class="line">        -uint64_t data_expiry_time_us</div>
<div class="line">        +Subscriber(string name)</div>
<div class="line">        +subscribe(bool* state) T</div>
<div class="line">        +waitFor(uint64_t timeout_usec) bool</div>
<div class="line">        +setDataExpiryTime_us(uint64_t time_us)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    SharedMemory &lt;|-- SharedMemoryPosix</div>
<div class="line">    Publisher~T~ *-- SharedMemory</div>
<div class="line">    Publisher~T~ *-- RingBuffer</div>
<div class="line">    Subscriber~T~ *-- SharedMemory</div>
<div class="line">    Subscriber~T~ *-- RingBuffer</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md124"></a>
Shared Memory Layout</h2>
<div class="fragment"><div class="line">graph TB</div>
<div class="line">    subgraph &quot;Shared Memory Segment&quot;</div>
<div class="line">        subgraph &quot;Metadata Area&quot;</div>
<div class="line">            MUTEX[pthread_mutex_t]</div>
<div class="line">            COND[pthread_cond_t]</div>
<div class="line">            ESIZE[element_size]</div>
<div class="line">            BUFNUM[buffer_num]</div>
<div class="line">        end</div>
<div class="line">        </div>
<div class="line">        subgraph &quot;Timestamp Area&quot;</div>
<div class="line">            TS0[timestamp[0]]</div>
<div class="line">            TS1[timestamp[1]]</div>
<div class="line">            TS2[timestamp[2]]</div>
<div class="line">            TSN[timestamp[n-1]]</div>
<div class="line">        end</div>
<div class="line">        </div>
<div class="line">        subgraph &quot;Data Area&quot;</div>
<div class="line">            DATA0[data_buffer[0]]</div>
<div class="line">            DATA1[data_buffer[1]]</div>
<div class="line">            DATA2[data_buffer[2]]</div>
<div class="line">            DATAN[data_buffer[n-1]]</div>
<div class="line">        end</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    MUTEX --&gt; COND</div>
<div class="line">    COND --&gt; ESIZE</div>
<div class="line">    ESIZE --&gt; BUFNUM</div>
<div class="line">    BUFNUM --&gt; TS0</div>
<div class="line">    TS0 --&gt; TS1</div>
<div class="line">    TS1 --&gt; TS2</div>
<div class="line">    TS2 --&gt; TSN</div>
<div class="line">    TSN --&gt; DATA0</div>
<div class="line">    DATA0 --&gt; DATA1</div>
<div class="line">    DATA1 --&gt; DATA2</div>
<div class="line">    DATA2 --&gt; DATAN</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md125"></a>
Data Flow</h2>
<h3><a class="anchor" id="autotoc_md126"></a>
Publish Process Flow</h3>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant App as Application</div>
<div class="line">    participant Pub as Publisher</div>
<div class="line">    participant RB as RingBuffer</div>
<div class="line">    participant SM as SharedMemory</div>
<div class="line">    </div>
<div class="line">    App-&gt;&gt;+Pub: publish(data)</div>
<div class="line">    Pub-&gt;&gt;+RB: getOldestBufferNum()</div>
<div class="line">    RB--&gt;&gt;-Pub: buffer_index</div>
<div class="line">    </div>
<div class="line">    loop Maximum 10 retries</div>
<div class="line">        Pub-&gt;&gt;+RB: allocateBuffer(buffer_index)</div>
<div class="line">        alt Buffer allocation success</div>
<div class="line">            RB--&gt;&gt;-Pub: true</div>
<div class="line">        else Buffer allocation failure</div>
<div class="line">            RB--&gt;&gt;Pub: false</div>
<div class="line">            Note over Pub: Wait 1ms</div>
<div class="line">            Pub-&gt;&gt;RB: getOldestBufferNum()</div>
<div class="line">            RB--&gt;&gt;Pub: new buffer_index</div>
<div class="line">        end</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    Pub-&gt;&gt;SM: Copy data to buffer</div>
<div class="line">    Pub-&gt;&gt;RB: setTimestamp_us(current_time, buffer_index)</div>
<div class="line">    Pub-&gt;&gt;RB: signal()</div>
<div class="line">    Note over RB: Notify waiting Subscribers</div>
<div class="line">    Pub--&gt;&gt;-App: Process complete</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md127"></a>
Subscribe Process Flow</h3>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant App as Application</div>
<div class="line">    participant Sub as Subscriber</div>
<div class="line">    participant RB as RingBuffer</div>
<div class="line">    participant SM as SharedMemory</div>
<div class="line">    </div>
<div class="line">    App-&gt;&gt;+Sub: subscribe(&amp;is_success)</div>
<div class="line">    </div>
<div class="line">    alt Shared memory disconnected</div>
<div class="line">        Sub-&gt;&gt;+SM: connect()</div>
<div class="line">        SM--&gt;&gt;-Sub: Connection result</div>
<div class="line">        alt Connection failed</div>
<div class="line">            Sub--&gt;&gt;App: (default_value, false)</div>
<div class="line">        end</div>
<div class="line">        Sub-&gt;&gt;RB: Create new RingBuffer instance</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    Sub-&gt;&gt;+RB: getNewestBufferNum()</div>
<div class="line">    RB--&gt;&gt;-Sub: buffer_index</div>
<div class="line">    </div>
<div class="line">    alt No valid buffer found</div>
<div class="line">        Sub--&gt;&gt;App: (previous_value, false)</div>
<div class="line">    else Valid buffer found</div>
<div class="line">        Sub-&gt;&gt;SM: Copy data from buffer</div>
<div class="line">        Sub--&gt;&gt;-App: (data, true)</div>
<div class="line">    end</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md128"></a>
waitFor Process Flow</h3>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant App as Application</div>
<div class="line">    participant Sub as Subscriber</div>
<div class="line">    participant RB as RingBuffer</div>
<div class="line">    </div>
<div class="line">    App-&gt;&gt;+Sub: waitFor(timeout_usec)</div>
<div class="line">    </div>
<div class="line">    alt Shared memory disconnected</div>
<div class="line">        Sub-&gt;&gt;Sub: Reconnection process</div>
<div class="line">        alt Reconnection failed</div>
<div class="line">            Sub--&gt;&gt;App: false</div>
<div class="line">        end</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    Sub-&gt;&gt;+RB: waitFor(timeout_usec)</div>
<div class="line">    Note over RB: Wait with pthread_cond_timedwait</div>
<div class="line">    </div>
<div class="line">    alt Signal received before timeout</div>
<div class="line">        RB--&gt;&gt;-Sub: true</div>
<div class="line">        Sub--&gt;&gt;-App: true</div>
<div class="line">    else Timeout</div>
<div class="line">        RB--&gt;&gt;Sub: false</div>
<div class="line">        Sub--&gt;&gt;App: false</div>
<div class="line">    end</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md129"></a>
📡 Communication Protocol</h1>
<h2><a class="anchor" id="autotoc_md130"></a>
Ring Buffer Algorithm</h2>
<h3><a class="anchor" id="autotoc_md131"></a>
Buffer Selection Algorithm</h3>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    Start([Start]) --&gt; GetOldest[Identify buffer with oldest timestamp]</div>
<div class="line">    GetOldest --&gt; TryAlloc{Try buffer allocation}</div>
<div class="line">    TryAlloc --&gt;|Success| WriteData[Write data]</div>
<div class="line">    TryAlloc --&gt;|Failure| CheckRetry{Retry count &lt; 10?}</div>
<div class="line">    CheckRetry --&gt;|Yes| Wait[Wait 1ms]</div>
<div class="line">    Wait --&gt; GetOldest</div>
<div class="line">    CheckRetry --&gt;|No| Error[Error: Buffer allocation failed]</div>
<div class="line">    WriteData --&gt; UpdateTime[Update timestamp]</div>
<div class="line">    UpdateTime --&gt; Signal[Send signal via condition variable]</div>
<div class="line">    Signal --&gt; End([End])</div>
<div class="line">    Error --&gt; End</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md132"></a>
Data Reading Algorithm</h3>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    Start([Start]) --&gt; CheckConn{Shared memory connected?}</div>
<div class="line">    CheckConn --&gt;|No| Reconnect[Try reconnection]</div>
<div class="line">    Reconnect --&gt; ConnSuccess{Connection success?}</div>
<div class="line">    ConnSuccess --&gt;|No| ReturnFail[Return failure]</div>
<div class="line">    ConnSuccess --&gt;|Yes| GetNewest</div>
<div class="line">    CheckConn --&gt;|Yes| GetNewest[Identify buffer with newest timestamp]</div>
<div class="line">    GetNewest --&gt; ValidBuffer{Valid buffer?}</div>
<div class="line">    ValidBuffer --&gt;|No| ReturnOld[Return previous value and failure flag]</div>
<div class="line">    ValidBuffer --&gt;|Yes| CheckExpiry{Data within expiry time?}</div>
<div class="line">    CheckExpiry --&gt;|No| ReturnOld</div>
<div class="line">    CheckExpiry --&gt;|Yes| ReadData[Read data]</div>
<div class="line">    ReadData --&gt; ReturnSuccess[Return data and success flag]</div>
<div class="line">    ReturnFail --&gt; End([End])</div>
<div class="line">    ReturnOld --&gt; End</div>
<div class="line">    ReturnSuccess --&gt; End</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md133"></a>
Synchronization Mechanism</h2>
<h3><a class="anchor" id="autotoc_md134"></a>
Mutex and Condition Variable</h3>
<div class="fragment"><div class="line">stateDiagram-v2</div>
<div class="line">    [*] --&gt; Unlocked : Initial state</div>
<div class="line">    </div>
<div class="line">    state Publisher {</div>
<div class="line">        Unlocked --&gt; Locked : pthread_mutex_lock</div>
<div class="line">        Locked --&gt; Writing : Buffer allocation success</div>
<div class="line">        Writing --&gt; Unlocked : pthread_mutex_unlock + pthread_cond_signal</div>
<div class="line">        Locked --&gt; Unlocked : Buffer allocation failure + pthread_mutex_unlock</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    state Subscriber {</div>
<div class="line">        Unlocked --&gt; Waiting : waitFor() called</div>
<div class="line">        Waiting --&gt; Unlocked : Timeout</div>
<div class="line">        Waiting --&gt; Processing : Signal received</div>
<div class="line">        Processing --&gt; Unlocked : Data reading complete</div>
<div class="line">    }</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md135"></a>
⚡ Performance Characteristics</h1>
<h2><a class="anchor" id="autotoc_md136"></a>
Memory Usage</h2>
<p>Shared memory segment size is calculated by the following formula:</p>
<div class="fragment"><div class="line">total_size = metadata_size + timestamp_array_size + data_array_size</div>
<div class="line"> </div>
<div class="line">metadata_size = sizeof(pthread_mutex_t) + sizeof(pthread_cond_t) + </div>
<div class="line">                sizeof(size_t) + sizeof(size_t)</div>
<div class="line"> </div>
<div class="line">timestamp_array_size = sizeof(uint64_t) * buffer_num</div>
<div class="line"> </div>
<div class="line">data_array_size = element_size * buffer_num</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md137"></a>
Latency Characteristics</h2>
<div class="fragment"><div class="line">graph LR</div>
<div class="line">    subgraph &quot;Latency Components&quot;</div>
<div class="line">        A[Application Processing] --&gt; B[Publisher Processing]</div>
<div class="line">        B --&gt; C[Mutex Acquisition]</div>
<div class="line">        C --&gt; D[Memory Copy]</div>
<div class="line">        D --&gt; E[Timestamp Update]</div>
<div class="line">        E --&gt; F[Signal Transmission]</div>
<div class="line">        F --&gt; G[Subscriber Processing]</div>
<div class="line">        G --&gt; H[Application Processing]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Typical Times&quot;</div>
<div class="line">        T1[App: ~1μs]</div>
<div class="line">        T2[Pub: ~2μs]</div>
<div class="line">        T3[Mutex: ~0.5μs]</div>
<div class="line">        T4[Copy: ~0.1μs]</div>
<div class="line">        T5[Time: ~0.1μs]</div>
<div class="line">        T6[Signal: ~0.5μs]</div>
<div class="line">        T7[Sub: ~2μs]</div>
<div class="line">        T8[App: ~1μs]</div>
<div class="line">    end</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md138"></a>
🔒 Security Considerations</h1>
<h2><a class="anchor" id="autotoc_md139"></a>
Access Permissions</h2>
<div class="fragment"><div class="line">graph TB</div>
<div class="line">    subgraph &quot;POSIX Permission Model&quot;</div>
<div class="line">        Owner[Owner]</div>
<div class="line">        Group[Group]</div>
<div class="line">        Others[Others]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Permission Types&quot;</div>
<div class="line">        Read[Read: S_IRUSR/S_IRGRP/S_IROTH]</div>
<div class="line">        Write[Write: S_IWUSR/S_IWGRP/S_IWOTH]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph &quot;Default Settings&quot;</div>
<div class="line">        Default[&quot;DEFAULT_PERM = 0666&lt;br/&gt;(All users read/write)&quot;]</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    Owner --&gt; Read</div>
<div class="line">    Owner --&gt; Write</div>
<div class="line">    Group --&gt; Read</div>
<div class="line">    Group --&gt; Write</div>
<div class="line">    Others --&gt; Read</div>
<div class="line">    Others --&gt; Write</div>
<div class="line">    </div>
<div class="line">    Default -.-&gt; Owner</div>
<div class="line">    Default -.-&gt; Group</div>
<div class="line">    Default -.-&gt; Others</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md140"></a>
Data Integrity</h2>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant P1 as Publisher 1</div>
<div class="line">    participant P2 as Publisher 2</div>
<div class="line">    participant Mutex as Mutex</div>
<div class="line">    participant Buffer as SharedBuffer</div>
<div class="line">    participant S as Subscriber</div>
<div class="line">    </div>
<div class="line">    Note over P1,S: Concurrent writes from multiple Publishers</div>
<div class="line">    </div>
<div class="line">    P1-&gt;&gt;+Mutex: lock()</div>
<div class="line">    P2-&gt;&gt;Mutex: lock() (blocked)</div>
<div class="line">    Mutex--&gt;&gt;-P1: Acquisition success</div>
<div class="line">    </div>
<div class="line">    P1-&gt;&gt;Buffer: Write data</div>
<div class="line">    P1-&gt;&gt;Buffer: Update timestamp</div>
<div class="line">    P1-&gt;&gt;+Mutex: unlock() + signal()</div>
<div class="line">    Mutex--&gt;&gt;-P2: Acquisition success</div>
<div class="line">    </div>
<div class="line">    P2-&gt;&gt;Buffer: Write data</div>
<div class="line">    P2-&gt;&gt;Buffer: Update timestamp</div>
<div class="line">    P2-&gt;&gt;Mutex: unlock() + signal()</div>
<div class="line">    </div>
<div class="line">    S-&gt;&gt;Buffer: Read latest data</div>
<div class="line">    Note over S: Gets P2&#39;s data</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md141"></a>
❌ Error Handling</h1>
<h2><a class="anchor" id="autotoc_md142"></a>
Error Classification and Response</h2>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    Error([Error Occurred]) --&gt; CheckType{Error Type}</div>
<div class="line">    </div>
<div class="line">    CheckType --&gt;|Initialization Error| InitError[Initialization Error]</div>
<div class="line">    CheckType --&gt;|Communication Error| CommError[Communication Error]</div>
<div class="line">    CheckType --&gt;|Memory Error| MemError[Memory Error]</div>
<div class="line">    CheckType --&gt;|Timeout| TimeoutError[Timeout Error]</div>
<div class="line">    </div>
<div class="line">    InitError --&gt; InitActions[・Name verification&lt;br/&gt;・Permission check&lt;br/&gt;・POD type verification]</div>
<div class="line">    CommError --&gt; CommActions[・Shared memory reconnection&lt;br/&gt;・Publisher side check&lt;br/&gt;・Process liveness check]</div>
<div class="line">    MemError --&gt; MemActions[・Memory shortage check&lt;br/&gt;・Segment deletion&lt;br/&gt;・System restart]</div>
<div class="line">    TimeoutError --&gt; TimeoutActions[・Timeout value adjustment&lt;br/&gt;・Publisher frequency check&lt;br/&gt;・System load check]</div>
<div class="line">    </div>
<div class="line">    InitActions --&gt; LogError[Output error log]</div>
<div class="line">    CommActions --&gt; LogError</div>
<div class="line">    MemActions --&gt; LogError</div>
<div class="line">    TimeoutActions --&gt; LogError</div>
<div class="line">    </div>
<div class="line">    LogError --&gt; Recovery{Recoverable?}</div>
<div class="line">    Recovery --&gt;|Yes| Retry[Retry process]</div>
<div class="line">    Recovery --&gt;|No| Abort[Abort process]</div>
<div class="line">    </div>
<div class="line">    Retry --&gt; Success{Success?}</div>
<div class="line">    Success --&gt;|Yes| End([Normal termination])</div>
<div class="line">    Success --&gt;|No| Recovery</div>
<div class="line">    Abort --&gt; End</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md143"></a>
🐍 Python Binding Design</h1>
<h2><a class="anchor" id="autotoc_md144"></a>
Boost.Python Wrapper Structure</h2>
<div class="fragment"><div class="line">classDiagram</div>
<div class="line">    class PublisherBool {</div>
<div class="line">        +PublisherBool(string name, bool arg, int buffer_num)</div>
<div class="line">        +_publish(bool data)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class PublisherInt {</div>
<div class="line">        +PublisherInt(string name, int arg, int buffer_num)</div>
<div class="line">        +_publish(int data)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class PublisherFloat {</div>
<div class="line">        +PublisherFloat(string name, float arg, int buffer_num)</div>
<div class="line">        +_publish(float data)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class SubscriberBool {</div>
<div class="line">        +SubscriberBool(string name, bool arg)</div>
<div class="line">        +_subscribe() tuple~bool, bool~</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class SubscriberInt {</div>
<div class="line">        +SubscriberInt(string name, int arg)</div>
<div class="line">        +_subscribe() tuple~int, bool~</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class SubscriberFloat {</div>
<div class="line">        +SubscriberFloat(string name, float arg)</div>
<div class="line">        +_subscribe() tuple~float, bool~</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class Publisher~T~ {</div>
<div class="line">        &lt;&lt;C++ Template&gt;&gt;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class Subscriber~T~ {</div>
<div class="line">        &lt;&lt;C++ Template&gt;&gt;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    Publisher~T~ &lt;|-- PublisherBool</div>
<div class="line">    Publisher~T~ &lt;|-- PublisherInt</div>
<div class="line">    Publisher~T~ &lt;|-- PublisherFloat</div>
<div class="line">    Subscriber~T~ &lt;|-- SubscriberBool</div>
<div class="line">    Subscriber~T~ &lt;|-- SubscriberInt</div>
<div class="line">    Subscriber~T~ &lt;|-- SubscriberFloat</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md145"></a>
Python/C++ Data Conversion</h2>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant Py as Python App</div>
<div class="line">    participant Boost as Boost.Python</div>
<div class="line">    participant Wrapper as C++ Wrapper</div>
<div class="line">    participant Core as SHM Core</div>
<div class="line">    </div>
<div class="line">    Note over Py,Core: Publish Process</div>
<div class="line">    Py-&gt;&gt;+Boost: pub.publish(data)</div>
<div class="line">    Boost-&gt;&gt;+Wrapper: _publish(converted_data)</div>
<div class="line">    Note over Boost: Python type → C++ type conversion</div>
<div class="line">    Wrapper-&gt;&gt;+Core: publish(data)</div>
<div class="line">    Core--&gt;&gt;-Wrapper: void</div>
<div class="line">    Wrapper--&gt;&gt;-Boost: void</div>
<div class="line">    Boost--&gt;&gt;-Py: None</div>
<div class="line">    </div>
<div class="line">    Note over Py,Core: Subscribe Process</div>
<div class="line">    Py-&gt;&gt;+Boost: data, success = sub.subscribe()</div>
<div class="line">    Boost-&gt;&gt;+Wrapper: _subscribe()</div>
<div class="line">    Wrapper-&gt;&gt;+Core: subscribe(&amp;is_success)</div>
<div class="line">    Core--&gt;&gt;-Wrapper: result_data</div>
<div class="line">    Wrapper--&gt;&gt;-Boost: make_tuple(result_data, is_success)</div>
<div class="line">    Note over Boost: C++ type → Python type conversion</div>
<div class="line">    Boost--&gt;&gt;-Py: (data, success)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md146"></a>
🔧 Extensibility Considerations</h1>
<h2><a class="anchor" id="autotoc_md147"></a>
Adding New Data Types</h2>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    Start([Add new type T]) --&gt; CheckPOD{POD type?}</div>
<div class="line">    CheckPOD --&gt;|Yes| UseTemplate[Use existing templates]</div>
<div class="line">    CheckPOD --&gt;|No| Specialize[Template specialization]</div>
<div class="line">    </div>
<div class="line">    UseTemplate --&gt; InstantiateC[Instantiate Publisher&lt;T&gt;,&lt;br/&gt;Subscriber&lt;T&gt; in C++]</div>
<div class="line">    Specialize --&gt; CustomImpl[Custom implementation&lt;br/&gt;・Serialization&lt;br/&gt;・Deserialization]</div>
<div class="line">    </div>
<div class="line">    CustomImpl --&gt; InstantiateC</div>
<div class="line">    InstantiateC --&gt; PythonNeeded{Python support needed?}</div>
<div class="line">    </div>
<div class="line">    PythonNeeded --&gt;|Yes| CreateWrapper[Create Boost.Python wrapper&lt;br/&gt;・PublisherT&lt;br/&gt;・SubscriberT]</div>
<div class="line">    PythonNeeded --&gt;|No| TestC[Implement C++ tests]</div>
<div class="line">    </div>
<div class="line">    CreateWrapper --&gt; UpdateModule[Add to BOOST_PYTHON_MODULE]</div>
<div class="line">    UpdateModule --&gt; TestPy[Implement Python tests]</div>
<div class="line">    TestPy --&gt; TestC</div>
<div class="line">    TestC --&gt; Document[Update documentation]</div>
<div class="line">    Document --&gt; End([Complete])</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md148"></a>
📚 References</h1>
<h2><a class="anchor" id="autotoc_md149"></a>
man shm_overview</h2>
<p>The following URL provides an overview of POSIX shared memory: <a href="https://linuxjm.osdn.jp/html/LDP_man-pages/man7/shm_overview.7.html">https://linuxjm.osdn.jp/html/LDP_man-pages/man7/shm_overview.7.html</a></p>
<h2><a class="anchor" id="autotoc_md150"></a>
Related Technical Specifications</h2>
<ul>
<li><b>POSIX.1-2001</b> Shared memory objects</li>
<li><b>POSIX.1-2001</b> pthread mutex and condition variables <br  />
</li>
<li><b>C++11</b> Standard layout types</li>
<li><b>Boost.Python 1.75+</b> Python bindings</li>
</ul>
<h2><a class="anchor" id="autotoc_md151"></a>
Additional Resources</h2>
<ul>
<li><b>Linux Kernel Documentation</b> - <code>/dev/shm</code> filesystem implementation</li>
<li><b>POSIX Real-time Extensions</b> - Inter-process synchronization</li>
<li><b>C++ Core Guidelines</b> - Memory safety and RAII patterns</li>
<li><b>Boost Documentation</b> - Python/C++ integration best practices</li>
</ul>
<hr  />
<p><b>📋 Technical Note</b>: This specification provides comprehensive documentation for the SHM library architecture, enabling developers and designers to understand, extend, and maintain the system effectively. For implementation examples, see the tutorial documentation. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jul 5 2025 13:54:48 for SHM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
