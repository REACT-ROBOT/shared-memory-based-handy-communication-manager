<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHM: üìã SHM Technical Specification - Complete System Architecture Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SHM
   </div>
   <div id="projectbrief">Shared-memory based Handy-communication Manager</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">üìã SHM Technical Specification - Complete System Architecture Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md106">üéØ Purpose</a></li>
<li class="level1"><a href="#autotoc_md107">üìñ Abstract</a><ul><li class="level2"><a href="#autotoc_md108">Framework Context</a></li>
<li class="level2"><a href="#autotoc_md109">üöÄ System Functions</a><ul><li class="level3"><a href="#autotoc_md110">Memory Management Process Hiding</a></li>
<li class="level3"><a href="#autotoc_md111">Pointer-Free Coding</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md112">üë• User Characteristics</a><ul><li class="level3"><a href="#autotoc_md113">üéì Developer</a></li>
<li class="level3"><a href="#autotoc_md114">üèóÔ∏è Designer</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md115">üìö Definitions and Terms</a><ul><li class="level3"><a href="#autotoc_md116">Local Memory</a></li>
<li class="level3"><a href="#autotoc_md117">Shared Memory</a></li>
<li class="level3"><a href="#autotoc_md118">Standard Layout Type</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md119">üèóÔ∏è Architecture Design</a><ul><li class="level2"><a href="#autotoc_md120">Overall System Architecture</a></li>
<li class="level2"><a href="#autotoc_md121">Layer Architecture</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md122">üîß Detailed Design</a><ul><li class="level2"><a href="#autotoc_md123">Class Hierarchy Structure</a></li>
<li class="level2"><a href="#autotoc_md124">Shared Memory Layout</a></li>
<li class="level2"><a href="#autotoc_md125">Data Flow</a><ul><li class="level3"><a href="#autotoc_md126">Publish Process Flow</a></li>
<li class="level3"><a href="#autotoc_md127">Subscribe Process Flow</a></li>
<li class="level3"><a href="#autotoc_md128">waitFor Process Flow</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md129">üì° Communication Protocol</a><ul><li class="level2"><a href="#autotoc_md130">Ring Buffer Algorithm</a><ul><li class="level3"><a href="#autotoc_md131">Buffer Selection Algorithm</a></li>
<li class="level3"><a href="#autotoc_md132">Data Reading Algorithm</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md133">Synchronization Mechanism</a><ul><li class="level3"><a href="#autotoc_md134">Mutex and Condition Variable</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md135">‚ö° Performance Characteristics</a><ul><li class="level2"><a href="#autotoc_md136">Memory Usage</a></li>
<li class="level2"><a href="#autotoc_md137">Latency Characteristics</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md138">üîí Security Considerations</a><ul><li class="level2"><a href="#autotoc_md139">Access Permissions</a></li>
<li class="level2"><a href="#autotoc_md140">Data Integrity</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md141">‚ùå Error Handling</a><ul><li class="level2"><a href="#autotoc_md142">Error Classification and Response</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md143">üêç Python Binding Design</a><ul><li class="level2"><a href="#autotoc_md144">Boost.Python Wrapper Structure</a></li>
<li class="level2"><a href="#autotoc_md145">Python/C++ Data Conversion</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md146">üîß Extensibility Considerations</a><ul><li class="level2"><a href="#autotoc_md147">Adding New Data Types</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md148">üìö References</a><ul><li class="level2"><a href="#autotoc_md149">man shm_overview</a></li>
<li class="level2"><a href="#autotoc_md150">Related Technical Specifications</a></li>
<li class="level2"><a href="#autotoc_md151">Additional Resources</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>[English | <a href="docs_jp/md_manual_spec_jp.html">Êó•Êú¨Ë™û</a>]</p>
<h1><a class="anchor" id="autotoc_md106"></a>
üéØ Purpose</h1>
<p>The purpose of SHM (Shared-memory based Handy-communication Manager) is to provide the most secure and fastest possible communication between different processes. It is also designed with careful consideration to make it easy for students to use. Please refer to README.md for installation instructions.</p>
<h1><a class="anchor" id="autotoc_md107"></a>
üìñ Abstract</h1>
<h2><a class="anchor" id="autotoc_md108"></a>
Framework Context</h2>
<p>The Instrumentation and Robotics Laboratory at Utsunomiya University uses shared memory for data exchange between programs, in addition to local memory generally used by programs.</p>
<p>Shared memory differs from local memory in several key aspects:</p><ul>
<li><b>Memory Management</b>: Developers must not release allocated memory (inadvertent release prevents data passing to other programs)</li>
<li><b>Programming Complexity</b>: Higher barrier for novice programmers due to pointer usage</li>
<li><b>Development Overhead</b>: Designers must create custom processes for each memory type when creating new libraries</li>
</ul>
<p>This framework <b>hides data exchange using shared memory</b> and provides <b>easy-to-understand inter-process communication</b> for novice programmers.</p>
<h2><a class="anchor" id="autotoc_md109"></a>
üöÄ System Functions</h2>
<h3><a class="anchor" id="autotoc_md110"></a>
Memory Management Process Hiding</h3>
<p>Easy inter-process communication is achieved by hiding shared memory area allocation and buffer access within classes. By default, only <b>standard layout type classes</b> are supported. Other classes can be supported by defining specialized Publishers/Subscribers for each case. See samples for details.</p>
<h3><a class="anchor" id="autotoc_md111"></a>
Pointer-Free Coding</h3>
<p>The system fundamentally only requires passing variables allocated in local memory to Publishers or receiving topics from Subscribers, <b>eliminating the need to code with shared memory pointers</b> as in traditional approaches.</p>
<h2><a class="anchor" id="autotoc_md112"></a>
üë• User Characteristics</h2>
<h3><a class="anchor" id="autotoc_md113"></a>
üéì Developer</h3>
<p>Developers create new programs using internal and external libraries, including this library. Primarily intended for <b>first-time programming students</b> such as fourth-year undergraduates.</p>
<h3><a class="anchor" id="autotoc_md114"></a>
üèóÔ∏è Designer</h3>
<p>Designers create new libraries using this framework and transfer current know-how to junior members. Primarily intended for <b>second-year master students</b>.</p>
<h2><a class="anchor" id="autotoc_md115"></a>
üìö Definitions and Terms</h2>
<h3><a class="anchor" id="autotoc_md116"></a>
Local Memory</h3>
<p>Local memory is a <b>virtual storage area accessible within a process</b>. It's the storage area used during normal programming. If not properly released after use, it may cause future problems (programs working correctly for a while may suddenly stop).</p>
<h3><a class="anchor" id="autotoc_md117"></a>
Shared Memory</h3>
<p>Shared memory is a <b>storage area that can be used commonly among processes</b>. It's allocated by special means and can be implemented in various ways. This implementation uses <b>POSIX file-mapped memory</b>, where data stored in shared memory is treated as a file. In Linux, the allocated memory area can be confirmed directly under <code>/dev/shm</code>.</p>
<h3><a class="anchor" id="autotoc_md118"></a>
Standard Layout Type</h3>
<p>A class or structure that:</p><ul>
<li>Contains no specific C++ language features (like virtual functions) not found in C</li>
<li>Has all members with the same access control</li>
<li>Enables <code>memcpy</code> operations</li>
<li>Has clearly defined layout for use in C programs</li>
</ul>
<p><b>Standard layout types have the following characteristics:</b></p><ul>
<li>No virtual functions or virtual base classes</li>
<li>All non-static data members have the same access control</li>
<li>All non-static members of class type are standard layout</li>
<li>All base classes have standard layout</li>
<li>No base class of the same type as the first non-static data member</li>
<li>Meets one of the following conditions:<ul>
<li>The most derived class has no non-static data members and only one base class with non-static data members</li>
<li>No base class contains non-static data members</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md119"></a>
üèóÔ∏è Architecture Design</h1>
<h2><a class="anchor" id="autotoc_md120"></a>
Overall System Architecture</h2>
<p> 
<div class="mermaid">
graph TB
    subgraph "Process A"
        PA[Application A]
        PubA[Publisher A]
    end
    
    subgraph "Process B"
        PB[Application B]
        SubB[Subscriber B]
    end
    
    subgraph "Process C"
        PC[Application C]
        SubC[Subscriber C]
    end
    
    subgraph "Shared Memory Area"
        SM[Shared Memory Segment]
        RB[Ring Buffer]
        Meta[Metadata]
    end
    
    PA --> PubA
    PubA --> SM
    SM --> RB
    RB --> SubB
    RB --> SubC
    SubB --> PB
    SubC --> PC
    
    SM --> Meta
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md121"></a>
Layer Architecture</h2>
<p> 
<div class="mermaid">
graph TB
    subgraph "Application Layer"
        APP[User Application]
    end
    
    subgraph "SHM API Layer"
        PUB["Publisher"]
        SUB["Subscriber"]
    end
    
    subgraph "Shared Memory Management Layer"
        SHM[SharedMemory]
        POSIX[SharedMemoryPosix]
        RB[RingBuffer]
    end
    
    subgraph "OS Layer"
        KERNEL[Linux Kernel]
        SHMFS["/dev/shm Filesystem"]
    end
    
    APP --> PUB
    APP --> SUB
    PUB --> SHM
    SUB --> SHM
    SHM --> POSIX
    POSIX --> RB
    POSIX --> KERNEL
    KERNEL --> SHMFS
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md122"></a>
üîß Detailed Design</h1>
<h2><a class="anchor" id="autotoc_md123"></a>
Class Hierarchy Structure</h2>
<p> 
<div class="mermaid">
classDiagram
    class SharedMemory {
        &lt;&lt;abstract&gt;&gt;
        #int shm_fd
        #int shm_oflag
        #PERM shm_perm
        #size_t shm_size
        #unsigned char* shm_ptr
        +SharedMemory(int oflag, PERM perm)
        +getSize() size_t
        +getPtr() unsigned char*
        +connect(size_t size)* bool
        +disconnect()* int
        +isDisconnected()* bool
    }
    
    class SharedMemoryPosix {
        -string shm_name
        +SharedMemoryPosix(string name, int oflag, PERM perm)
        +connect(size_t size) bool
        +disconnect() int
        +isDisconnected() bool
    }
    
    class RingBuffer {
        -unsigned char* memory_ptr
        -pthread_mutex_t* mutex
        -pthread_cond_t* condition
        -size_t* element_size
        -size_t* buf_num
        -atomic_uint64_t* timestamp_list
        -unsigned char* data_list
        -uint64_t timestamp_us
        -uint64_t data_expiry_time_us
        +RingBuffer(unsigned char* first_ptr, size_t size, int buffer_num)
        +getSize(size_t element_size, int buffer_num)$ size_t
        +getTimestamp_us() uint64_t
        +setTimestamp_us(uint64_t input_time_us, int buffer_num)
        +getNewestBufferNum() int
        +getOldestBufferNum() int
        +allocateBuffer(int buffer_num) bool
        +getElementSize() size_t
        +getDataList() unsigned char*
        +signal()
        +waitFor(uint64_t timeout_usec) bool
        +isUpdated() bool
        +setDataExpiryTime_us(uint64_t time_us)
    }
    
    class PublisherT {
        -string shm_name
        -int shm_buf_num
        -PERM shm_perm
        -unique_ptr_SharedMemory shared_memory
        -unique_ptr_RingBuffer ring_buffer
        -size_t data_size
        +Publisher(string name, int buffer_num, PERM perm)
        +publish(const T& data)
    }
    
    class SubscriberT {
        -string shm_name
        -unique_ptr_SharedMemory shared_memory
        -unique_ptr_RingBuffer ring_buffer
        -int current_reading_buffer
        -uint64_t data_expiry_time_us
        +Subscriber(string name)
        +subscribe(bool* state) T
        +waitFor(uint64_t timeout_usec) bool
        +setDataExpiryTime_us(uint64_t time_us)
    }
    
    SharedMemory <|-- SharedMemoryPosix
    PublisherT *-- SharedMemory
    PublisherT *-- RingBuffer
    SubscriberT *-- SharedMemory
    SubscriberT *-- RingBuffer
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md124"></a>
Shared Memory Layout</h2>
<p> 
<div class="mermaid">
graph TB
    subgraph "Shared Memory Segment"
        subgraph "Metadata Area"
            MUTEX[pthread_mutex_t]
            COND[pthread_cond_t]
            ESIZE[element_size]
            BUFNUM[buffer_num]
        end
        
        subgraph "Timestamp Area"
            TS0["timestamp[0]"]
            TS1["timestamp[1]"]
            TS2["timestamp[2]"]
            TSN["timestamp[n-1]"]
        end
        
        subgraph "Data Area"
            DATA0["data_buffer[0]"]
            DATA1["data_buffer[1]"]
            DATA2["data_buffer[2]"]
            DATAN["data_buffer[n-1]"]
        end
    end
    
    MUTEX --> COND
    COND --> ESIZE
    ESIZE --> BUFNUM
    BUFNUM --> TS0
    TS0 --> TS1
    TS1 --> TS2
    TS2 --> TSN
    TSN --> DATA0
    DATA0 --> DATA1
    DATA1 --> DATA2
    DATA2 --> DATAN
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md125"></a>
Data Flow</h2>
<h3><a class="anchor" id="autotoc_md126"></a>
Publish Process Flow</h3>
<p> 
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant Pub as Publisher
    participant RB as RingBuffer
    participant SM as SharedMemory
    
    App->>+Pub: publish(data)
    Pub->>+RB: getOldestBufferNum()
    RB-->>-Pub: buffer_index
    
    loop Maximum 10 retries
        Pub->>+RB: allocateBuffer(buffer_index)
        alt Buffer allocation success
            RB-->>-Pub: true
        else Buffer allocation failure
            RB-->>Pub: false
            Note over Pub: Wait 1ms
            Pub->>RB: getOldestBufferNum()
            RB-->>Pub: new buffer_index
        end
    end
    
    Pub->>SM: Copy data to buffer
    Pub->>RB: setTimestamp_us(current_time, buffer_index)
    Pub->>RB: signal()
    Note over RB: Notify waiting Subscribers
    Pub-->>-App: Process complete
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h3><a class="anchor" id="autotoc_md127"></a>
Subscribe Process Flow</h3>
<p> 
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant Sub as Subscriber
    participant RB as RingBuffer
    participant SM as SharedMemory
    
    App->>+Sub: subscribe(&is_success)
    
    alt Shared memory disconnected
        Sub->>+SM: connect()
        SM-->>-Sub: Connection result
        alt Connection failed
            Sub-->>App: (default_value, false)
        end
        Sub->>RB: Create new RingBuffer instance
    end
    
    Sub->>+RB: getNewestBufferNum()
    RB-->>-Sub: buffer_index
    
    alt No valid buffer found
        Sub-->>App: (previous_value, false)
    else Valid buffer found
        Sub->>SM: Copy data from buffer
        Sub-->>-App: (data, true)
    end
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h3><a class="anchor" id="autotoc_md128"></a>
waitFor Process Flow</h3>
<p> 
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant Sub as Subscriber
    participant RB as RingBuffer
    
    App->>+Sub: waitFor(timeout_usec)
    
    alt Shared memory disconnected
        Sub->>Sub: Reconnection process
        alt Reconnection failed
            Sub-->>App: false
        end
    end
    
    Sub->>+RB: waitFor(timeout_usec)
    Note over RB: Wait with pthread_cond_timedwait
    
    alt Signal received before timeout
        RB-->>-Sub: true
        Sub-->>-App: true
    else Timeout
        RB-->>Sub: false
        Sub-->>App: false
    end
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md129"></a>
üì° Communication Protocol</h1>
<h2><a class="anchor" id="autotoc_md130"></a>
Ring Buffer Algorithm</h2>
<h3><a class="anchor" id="autotoc_md131"></a>
Buffer Selection Algorithm</h3>
<p> 
<div class="mermaid">
flowchart TD
    Start([Start]) --> GetOldest[Identify buffer with oldest timestamp]
    GetOldest --> TryAlloc{Try buffer allocation}
    TryAlloc -->|Success| WriteData[Write data]
    TryAlloc -->|Failure| CheckRetry{Retry count < 10?}
    CheckRetry -->|Yes| Wait[Wait 1ms]
    Wait --> GetOldest
    CheckRetry -->|No| Error[Error: Buffer allocation failed]
    WriteData --> UpdateTime[Update timestamp]
    UpdateTime --> Signal[Send signal via condition variable]
    Signal --> End([End])
    Error --> End
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h3><a class="anchor" id="autotoc_md132"></a>
Data Reading Algorithm</h3>
<p> 
<div class="mermaid">
flowchart TD
    Start([Start]) --> CheckConn{Shared memory connected?}
    CheckConn -->|No| Reconnect[Try reconnection]
    Reconnect --> ConnSuccess{Connection success?}
    ConnSuccess -->|No| ReturnFail[Return failure]
    ConnSuccess -->|Yes| GetNewest
    CheckConn -->|Yes| GetNewest[Identify buffer with newest timestamp]
    GetNewest --> ValidBuffer{Valid buffer?}
    ValidBuffer -->|No| ReturnOld[Return previous value and failure flag]
    ValidBuffer -->|Yes| CheckExpiry{Data within expiry time?}
    CheckExpiry -->|No| ReturnOld
    CheckExpiry -->|Yes| ReadData[Read data]
    ReadData --> ReturnSuccess[Return data and success flag]
    ReturnFail --> End([End])
    ReturnOld --> End
    ReturnSuccess --> End
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md133"></a>
Synchronization Mechanism</h2>
<h3><a class="anchor" id="autotoc_md134"></a>
Mutex and Condition Variable</h3>
<p> 
<div class="mermaid">
stateDiagram-v2
    [*] --> Unlocked : Initial state
    
    state Publisher {
        Unlocked --> Locked : pthread_mutex_lock
        Locked --> Writing : Buffer allocation success
        Writing --> Unlocked : pthread_mutex_unlock + pthread_cond_signal
        Locked --> Unlocked : Buffer allocation failure + pthread_mutex_unlock
    }
    
    state Subscriber {
        Unlocked --> Waiting : waitFor() called
        Waiting --> Unlocked : Timeout
        Waiting --> Processing : Signal received
        Processing --> Unlocked : Data reading complete
    }
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md135"></a>
‚ö° Performance Characteristics</h1>
<h2><a class="anchor" id="autotoc_md136"></a>
Memory Usage</h2>
<p>Shared memory segment size is calculated by the following formula:</p>
<div class="fragment"><div class="line">total_size = metadata_size + timestamp_array_size + data_array_size</div>
<div class="line"> </div>
<div class="line">metadata_size = sizeof(pthread_mutex_t) + sizeof(pthread_cond_t) + </div>
<div class="line">                sizeof(size_t) + sizeof(size_t)</div>
<div class="line"> </div>
<div class="line">timestamp_array_size = sizeof(uint64_t) * buffer_num</div>
<div class="line"> </div>
<div class="line">data_array_size = element_size * buffer_num</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md137"></a>
Latency Characteristics</h2>
<p> 
<div class="mermaid">
graph LR
    subgraph "Latency Components"
        A[Application Processing] --> B[Publisher Processing]
        B --> C[Mutex Acquisition]
        C --> D[Memory Copy]
        D --> E[Timestamp Update]
        E --> F[Signal Transmission]
        F --> G[Subscriber Processing]
        G --> H[Application Processing]
    end
    
    subgraph "Typical Times"
        T1[App: ~1Œºs]
        T2[Pub: ~2Œºs]
        T3[Mutex: ~0.5Œºs]
        T4[Copy: ~0.1Œºs]
        T5[Time: ~0.1Œºs]
        T6[Signal: ~0.5Œºs]
        T7[Sub: ~2Œºs]
        T8[App: ~1Œºs]
    end
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md138"></a>
üîí Security Considerations</h1>
<h2><a class="anchor" id="autotoc_md139"></a>
Access Permissions</h2>
<p> 
<div class="mermaid">
graph TB
    subgraph "POSIX Permission Model"
        Owner[Owner]
        Group[Group]
        Others[Others]
    end
    
    subgraph "Permission Types"
        Read[Read: S_IRUSR/S_IRGRP/S_IROTH]
        Write[Write: S_IWUSR/S_IWGRP/S_IWOTH]
    end
    
    subgraph "Default Settings"
        Default["DEFAULT_PERM = 0666<br/>(All users read/write)"]
    end
    
    Owner --> Read
    Owner --> Write
    Group --> Read
    Group --> Write
    Others --> Read
    Others --> Write
    
    Default -.-> Owner
    Default -.-> Group
    Default -.-> Others
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md140"></a>
Data Integrity</h2>
<p> 
<div class="mermaid">
sequenceDiagram
    participant P1 as Publisher 1
    participant P2 as Publisher 2
    participant Mutex as Mutex
    participant Buffer as SharedBuffer
    participant S as Subscriber
    
    Note over P1,S: Concurrent writes from multiple Publishers
    
    P1->>+Mutex: lock()
    P2->>Mutex: lock() (blocked)
    Mutex-->>-P1: Acquisition success
    
    P1->>Buffer: Write data
    P1->>Buffer: Update timestamp
    P1->>+Mutex: unlock() + signal()
    Mutex-->>-P2: Acquisition success
    
    P2->>Buffer: Write data
    P2->>Buffer: Update timestamp
    P2->>Mutex: unlock() + signal()
    
    S->>Buffer: Read latest data
    Note over S: Gets P2's data
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md141"></a>
‚ùå Error Handling</h1>
<h2><a class="anchor" id="autotoc_md142"></a>
Error Classification and Response</h2>
<p> 
<div class="mermaid">
flowchart TD
    Error([Error Occurred]) --> CheckType{Error Type}
    
    CheckType -->|Initialization Error| InitError[Initialization Error]
    CheckType -->|Communication Error| CommError[Communication Error]
    CheckType -->|Memory Error| MemError[Memory Error]
    CheckType -->|Timeout| TimeoutError[Timeout Error]
    
    InitError --> InitActions[„ÉªName verification<br/>„ÉªPermission check<br/>„ÉªPOD type verification]
    CommError --> CommActions[„ÉªShared memory reconnection<br/>„ÉªPublisher side check<br/>„ÉªProcess liveness check]
    MemError --> MemActions[„ÉªMemory shortage check<br/>„ÉªSegment deletion<br/>„ÉªSystem restart]
    TimeoutError --> TimeoutActions[„ÉªTimeout value adjustment<br/>„ÉªPublisher frequency check<br/>„ÉªSystem load check]
    
    InitActions --> LogError[Output error log]
    CommActions --> LogError
    MemActions --> LogError
    TimeoutActions --> LogError
    
    LogError --> Recovery{Recoverable?}
    Recovery -->|Yes| Retry[Retry process]
    Recovery -->|No| Abort[Abort process]
    
    Retry --> Success{Success?}
    Success -->|Yes| End([Normal termination])
    Success -->|No| Recovery
    Abort --> End
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md143"></a>
üêç Python Binding Design</h1>
<h2><a class="anchor" id="autotoc_md144"></a>
Boost.Python Wrapper Structure</h2>
<p> 
<div class="mermaid">
classDiagram
    class PublisherBool {
        +PublisherBool(string name, bool arg, int buffer_num)
        +_publish(bool data)
    }
    
    class PublisherInt {
        +PublisherInt(string name, int arg, int buffer_num)
        +_publish(int data)
    }
    
    class PublisherFloat {
        +PublisherFloat(string name, float arg, int buffer_num)
        +_publish(float data)
    }
    
    class SubscriberBool {
        +SubscriberBool(string name, bool arg)
        +_subscribe() (bool,bool)
    }
    
    class SubscriberInt {
        +SubscriberInt(string name, int arg)
        +_subscribe() (int,bool)
    }
    
    class SubscriberFloat {
        +SubscriberFloat(string name, float arg)
        +_subscribe() (float,bool)
    }
    
    class Publisher {
        &lt;&lt;C++ Template&gt;&gt;
    }
    
    class Subscriber {
        &lt;&lt;C++ Template&gt;&gt;
    }
    
    Publisher <|-- PublisherBool
    Publisher <|-- PublisherInt
    Publisher <|-- PublisherFloat
    Subscriber <|-- SubscriberBool
    Subscriber <|-- SubscriberInt
    Subscriber <|-- SubscriberFloat
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h2><a class="anchor" id="autotoc_md145"></a>
Python/C++ Data Conversion</h2>
<p> 
<div class="mermaid">
sequenceDiagram
    participant Py as Python App
    participant Boost as Boost.Python
    participant Wrapper as C++ Wrapper
    participant Core as SHM Core
    
    Note over Py,Core: Publish Process
    Py->>+Boost: pub.publish(data)
    Boost->>+Wrapper: _publish(converted_data)
    Note over Boost: Python type ‚Üí C++ type conversion
    Wrapper->>+Core: publish(data)
    Core-->>-Wrapper: void
    Wrapper-->>-Boost: void
    Boost-->>-Py: None
    
    Note over Py,Core: Subscribe Process
    Py->>+Boost: data, success = sub.subscribe()
    Boost->>+Wrapper: _subscribe()
    Wrapper->>+Core: subscribe(&is_success)
    Core-->>-Wrapper: result_data
    Wrapper-->>-Boost: make_tuple(result_data, is_success)
    Note over Boost: C++ type ‚Üí Python type conversion
    Boost-->>-Py: (data, success)
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md146"></a>
üîß Extensibility Considerations</h1>
<h2><a class="anchor" id="autotoc_md147"></a>
Adding New Data Types</h2>
<p> 
<div class="mermaid">
flowchart TD
    Start([Add new type T]) --> CheckPOD{POD type?}
    CheckPOD -->|Yes| UseTemplate[Use existing templates]
    CheckPOD -->|No| Specialize[Template specialization]
    
    UseTemplate --> InstantiateC["Instantiate PublisherT,<br/>SubscriberT in C++"]
    Specialize --> CustomImpl["Custom implementation<br/>„ÉªSerialization<br/>„ÉªDeserialization"]
    
    CustomImpl --> InstantiateC
    InstantiateC --> PythonNeeded{Python support needed?}
    
    PythonNeeded -->|Yes| CreateWrapper["Create Boost.Python wrapper<br/>„ÉªPublisherT<br/>„ÉªSubscriberT"]
    PythonNeeded -->|No| TestC[Implement C++ tests]
    
    CreateWrapper --> UpdateModule[Add to BOOST_PYTHON_MODULE]
    UpdateModule --> TestPy[Implement Python tests]
    TestPy --> TestC
    TestC --> Document[Update documentation]
    Document --> End([Complete])
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
</p>
<h1><a class="anchor" id="autotoc_md148"></a>
üìö References</h1>
<h2><a class="anchor" id="autotoc_md149"></a>
man shm_overview</h2>
<p>The following URL provides an overview of POSIX shared memory: <a href="https://linuxjm.osdn.jp/html/LDP_man-pages/man7/shm_overview.7.html">https://linuxjm.osdn.jp/html/LDP_man-pages/man7/shm_overview.7.html</a></p>
<h2><a class="anchor" id="autotoc_md150"></a>
Related Technical Specifications</h2>
<ul>
<li><b>POSIX.1-2001</b> Shared memory objects</li>
<li><b>POSIX.1-2001</b> pthread mutex and condition variables <br  />
</li>
<li><b>C++11</b> Standard layout types</li>
<li><b>Boost.Python 1.75+</b> Python bindings</li>
</ul>
<h2><a class="anchor" id="autotoc_md151"></a>
Additional Resources</h2>
<ul>
<li><b>Linux Kernel Documentation</b> - <code>/dev/shm</code> filesystem implementation</li>
<li><b>POSIX Real-time Extensions</b> - Inter-process synchronization</li>
<li><b>C++ Core Guidelines</b> - Memory safety and RAII patterns</li>
<li><b>Boost Documentation</b> - Python/C++ integration best practices</li>
</ul>
<hr  />
<p><b>üìã Technical Note</b>: This specification provides comprehensive documentation for the SHM library architecture, enabling developers and designers to understand, extend, and maintain the system effectively. For implementation examples, see the tutorial documentation. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jul 6 2025 00:08:41 for SHM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
